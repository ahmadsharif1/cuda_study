<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1400 1200" font-family="'Courier New', monospace">
  <style>
    .title { font-size: 22px; font-weight: bold; fill: #222; }
    .section-title { font-size: 17px; font-weight: bold; fill: #333; }
    .subtitle { font-size: 13px; font-weight: bold; fill: #555; }
    .label { font-size: 11px; fill: #333; }
    .small { font-size: 10px; fill: #555; }
    .tiny { font-size: 9px; fill: #666; }
    .code { font-size: 10px; fill: #333; font-family: monospace; }
    .bold { font-weight: bold; }
    .a-fill { fill: #4A90D9; }
    .a-light { fill: #CADFF5; }
    .b-fill { fill: #27AE60; }
    .b-light { fill: #B8E6CC; }
    .c-fill { fill: #E67E22; }
    .c-light { fill: #FDEBD0; }
    .warp-fill { fill: #F1C40F; opacity: 0.6; }
    .coalesced { fill: #8E44AD; }
    .coalesced-light { fill: #D7BDE2; }
    .strided { fill: #C0392B; }
    .reg-fill { fill: #ECF0F1; }
    .outline { fill: none; stroke: #333; stroke-width: 1; }
    .outline-bold { fill: none; stroke: #333; stroke-width: 2; }
    .arrow { fill: none; stroke: #555; stroke-width: 1.5; marker-end: url(#arrowhead); }
    .arrow-bold { fill: none; stroke: #333; stroke-width: 2; marker-end: url(#arrowhead); }
    .dashed { stroke-dasharray: 4,3; }
    .thread-grid { fill: #F9F9F9; stroke: #CCC; stroke-width: 0.5; }
    .broadcast { fill: #2ECC71; opacity: 0.3; }
    .bank-conflict { fill: #E74C3C; opacity: 0.3; }
    .dim-label { font-size: 11px; fill: #888; font-style: italic; }
  </style>
  <defs>
    <marker id="arrowhead" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto">
      <path d="M0,0 L8,3 L0,6 Z" fill="#555"/>
    </marker>
    <marker id="arrowhead-red" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto">
      <path d="M0,0 L8,3 L0,6 Z" fill="#C0392B"/>
    </marker>
    <marker id="arrowhead-purple" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto">
      <path d="M0,0 L8,3 L0,6 Z" fill="#8E44AD"/>
    </marker>
    <linearGradient id="fma-grad" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#F39C12;stop-opacity:0.8"/>
      <stop offset="100%" style="stop-color:#E74C3C;stop-opacity:0.8"/>
    </linearGradient>
  </defs>

  <!-- Background -->
  <rect width="1400" height="1200" fill="#FAFAFA" rx="8"/>

  <!-- Title -->
  <text x="700" y="35" text-anchor="middle" class="title">Naive GEMM: Memory Access Patterns</text>
  <text x="700" y="55" text-anchor="middle" class="small">block(16,16), grid((N+15)/16, (M+15)/16), 1 thread = 1 output element, NO shared memory</text>

  <!-- ============================================================ -->
  <!-- SECTION 1: Thread-to-Output Mapping                          -->
  <!-- ============================================================ -->
  <line x1="40" y1="70" x2="1360" y2="70" stroke="#DDD" stroke-width="1"/>
  <text x="50" y="95" class="section-title">1. Thread-to-Output Mapping</text>

  <!-- A matrix -->
  <g transform="translate(80, 115)">
    <text x="40" y="-5" text-anchor="middle" class="subtitle">A [MxK]</text>
    <rect width="80" height="160" class="a-light" stroke="#4A90D9" stroke-width="2" rx="2"/>
    <text x="-10" y="10" text-anchor="end" class="tiny">0</text>
    <text x="-10" y="85" text-anchor="end" class="tiny">row</text>
    <text x="-10" y="158" text-anchor="end" class="tiny">M-1</text>
    <text x="40" y="178" text-anchor="middle" class="dim-label">K cols</text>
    <text x="-25" y="80" text-anchor="middle" class="dim-label" transform="rotate(-90,-25,80)">M rows</text>
    <!-- Highlight one row -->
    <rect x="0" y="72" width="80" height="12" fill="#4A90D9" opacity="0.5" rx="1"/>
    <text x="90" y="82" class="tiny" fill="#4A90D9">row = blockIdx.y*16 + ty</text>
  </g>

  <!-- Multiply sign -->
  <text x="195" y="210" text-anchor="middle" font-size="28" fill="#333">x</text>

  <!-- B matrix -->
  <g transform="translate(220, 140)">
    <text x="80" y="-5" text-anchor="middle" class="subtitle">B [KxN]</text>
    <rect width="160" height="80" class="b-light" stroke="#27AE60" stroke-width="2" rx="2"/>
    <text x="2" y="95" text-anchor="start" class="tiny">0</text>
    <text x="78" y="95" text-anchor="middle" class="tiny">col</text>
    <text x="155" y="95" text-anchor="end" class="tiny">N-1</text>
    <text x="80" y="108" text-anchor="middle" class="dim-label">N cols</text>
    <text x="-15" y="40" text-anchor="middle" class="dim-label" transform="rotate(-90,-15,40)">K rows</text>
    <!-- Highlight one column -->
    <rect x="75" y="0" width="12" height="80" fill="#27AE60" opacity="0.5" rx="1"/>
    <text x="80" y="-12" text-anchor="middle" class="tiny" fill="#27AE60">col = blockIdx.x*16 + tx</text>
  </g>

  <!-- Equals sign -->
  <text x="425" y="195" text-anchor="middle" font-size="28" fill="#333">=</text>

  <!-- C matrix with 16x16 thread block shown -->
  <g transform="translate(460, 115)">
    <text x="80" y="-5" text-anchor="middle" class="subtitle">C [MxN] output</text>
    <rect width="160" height="160" class="c-light" stroke="#E67E22" stroke-width="2" rx="2"/>
    <text x="80" y="178" text-anchor="middle" class="dim-label">N cols</text>
    <text x="-20" y="80" text-anchor="middle" class="dim-label" transform="rotate(-90,-20,80)">M rows</text>

    <!-- Show one 16x16 block highlighted -->
    <rect x="30" y="50" width="40" height="40" fill="#E67E22" opacity="0.35" stroke="#E67E22" stroke-width="1.5" rx="2"/>
    <text x="50" y="73" text-anchor="middle" class="tiny" fill="#C0392B" font-weight="bold">16x16</text>
    <text x="50" y="83" text-anchor="middle" class="tiny" fill="#C0392B" font-weight="bold">block</text>

    <!-- Show grid lines to suggest block decomposition -->
    <line x1="30" y1="0" x2="30" y2="160" stroke="#E67E22" stroke-width="0.3" stroke-dasharray="3,3" opacity="0.5"/>
    <line x1="70" y1="0" x2="70" y2="160" stroke="#E67E22" stroke-width="0.3" stroke-dasharray="3,3" opacity="0.5"/>
    <line x1="110" y1="0" x2="110" y2="160" stroke="#E67E22" stroke-width="0.3" stroke-dasharray="3,3" opacity="0.5"/>
    <line x1="0" y1="50" x2="160" y2="50" stroke="#E67E22" stroke-width="0.3" stroke-dasharray="3,3" opacity="0.5"/>
    <line x1="0" y1="90" x2="160" y2="90" stroke="#E67E22" stroke-width="0.3" stroke-dasharray="3,3" opacity="0.5"/>
    <line x1="0" y1="130" x2="160" y2="130" stroke="#E67E22" stroke-width="0.3" stroke-dasharray="3,3" opacity="0.5"/>
  </g>

  <!-- Legend / explanation -->
  <g transform="translate(680, 120)">
    <rect x="0" y="0" width="380" height="165" fill="white" stroke="#DDD" stroke-width="1" rx="6"/>
    <text x="190" y="22" text-anchor="middle" class="subtitle">Thread Block Layout</text>
    <line x1="10" y1="30" x2="370" y2="30" stroke="#EEE"/>
    <text x="15" y="48" class="code">dim3 block(16, 16);  // 256 threads</text>
    <text x="15" y="64" class="code">dim3 grid((N+15)/16, (M+15)/16);</text>
    <line x1="10" y1="74" x2="370" y2="74" stroke="#EEE"/>
    <text x="15" y="92" class="code">row = blockIdx.y * 16 + threadIdx.y</text>
    <text x="15" y="108" class="code">col = blockIdx.x * 16 + threadIdx.x</text>
    <text x="15" y="124" class="code">C[row][col] = dot(A[row,:], B[:,col])</text>
    <line x1="10" y1="134" x2="370" y2="134" stroke="#EEE"/>
    <text x="15" y="152" class="code bold" fill="#C0392B">Each thread: 1 output, K FMAs, 2K global loads</text>
  </g>

  <!-- ============================================================ -->
  <!-- SECTION 2: Global Memory Access Pattern                      -->
  <!-- ============================================================ -->
  <line x1="40" y1="300" x2="1360" y2="300" stroke="#DDD" stroke-width="1"/>
  <text x="50" y="325" class="section-title">2. Global Memory Access Pattern (Warp 0, inner loop iteration i)</text>

  <!-- LEFT: A reads -->
  <g transform="translate(60, 345)">
    <text x="240" y="0" text-anchor="middle" class="subtitle" fill="#4A90D9">A reads: A[row * K + i] -- broadcast-like from L1</text>

    <!-- Show warp structure: 32 threads = 2 rows of 16 -->
    <g transform="translate(30, 25)">
      <text x="0" y="-5" class="small bold">Warp 0 = 32 threads (ty=0..1, tx=0..15):</text>

      <!-- Row ty=0: threads with same row read same A element -->
      <rect x="0" y="8" width="440" height="28" fill="#4A90D9" opacity="0.15" stroke="#4A90D9" stroke-width="1" rx="3"/>
      <text x="5" y="26" class="tiny" fill="#4A90D9" font-weight="bold">ty=0, tx=0..15:</text>
      <text x="120" y="26" class="code" fill="#4A90D9">All 16 threads read A[row0, i] -- SAME address (L1 broadcast)</text>

      <!-- Row ty=1: same pattern, different row -->
      <rect x="0" y="40" width="440" height="28" fill="#27AE60" opacity="0.15" stroke="#27AE60" stroke-width="1" rx="3"/>
      <text x="5" y="58" class="tiny" fill="#27AE60" font-weight="bold">ty=1, tx=0..15:</text>
      <text x="120" y="58" class="code" fill="#27AE60">All 16 threads read A[row1, i] -- SAME address (L1 broadcast)</text>

      <!-- Memory layout -->
      <text x="0" y="88" class="subtitle">Global memory for A reads (one inner loop step):</text>
      <rect x="0" y="96" width="180" height="22" fill="#4A90D9" opacity="0.3" stroke="#4A90D9" rx="3"/>
      <text x="90" y="112" text-anchor="middle" class="small" fill="#333">A[row0, i] -- 1 float (4B)</text>
      <text x="200" y="112" class="tiny" fill="#C0392B">addr: row0*K + i</text>

      <text x="90" y="128" text-anchor="middle" class="tiny" fill="#C0392B">stride = K floats apart</text>

      <rect x="0" y="135" width="180" height="22" fill="#27AE60" opacity="0.3" stroke="#27AE60" rx="3"/>
      <text x="90" y="151" text-anchor="middle" class="small" fill="#333">A[row1, i] -- 1 float (4B)</text>
      <text x="200" y="151" class="tiny" fill="#C0392B">addr: row1*K + i</text>

      <!-- Verdict -->
      <rect x="0" y="170" width="440" height="26" fill="#FCF3CF" stroke="#F1C40F" rx="4"/>
      <text x="220" y="188" text-anchor="middle" class="small" fill="#7D6608" font-weight="bold">2 cache lines fetched per warp, but only 1 float used from each (low utilization)</text>
    </g>
  </g>

  <!-- RIGHT: B reads -->
  <g transform="translate(560, 345)">
    <text x="360" y="0" text-anchor="middle" class="subtitle" fill="#8E44AD">B reads: B[i * N + col] -- COALESCED within half-warp</text>

    <g transform="translate(30, 25)">
      <text x="0" y="-5" class="small bold">Warp 0: threads in same row read consecutive B columns:</text>

      <!-- Show 16 threads reading consecutive B elements -->
      <g transform="translate(0, 10)">
        <rect x="0" y="0" width="28" height="26" fill="#8E44AD" opacity="0.6" stroke="#2C3E50" stroke-width="0.8" rx="1"/>
        <rect x="28" y="0" width="28" height="26" fill="#8E44AD" opacity="0.6" stroke="#2C3E50" stroke-width="0.8" rx="1"/>
        <rect x="56" y="0" width="28" height="26" fill="#8E44AD" opacity="0.6" stroke="#2C3E50" stroke-width="0.8" rx="1"/>
        <rect x="84" y="0" width="28" height="26" fill="#8E44AD" opacity="0.6" stroke="#2C3E50" stroke-width="0.8" rx="1"/>
        <rect x="112" y="0" width="28" height="26" fill="#8E44AD" opacity="0.6" stroke="#2C3E50" stroke-width="0.8" rx="1"/>
        <rect x="140" y="0" width="28" height="26" fill="#8E44AD" opacity="0.6" stroke="#2C3E50" stroke-width="0.8" rx="1"/>
        <rect x="168" y="0" width="28" height="26" fill="#8E44AD" opacity="0.6" stroke="#2C3E50" stroke-width="0.8" rx="1"/>
        <rect x="196" y="0" width="28" height="26" fill="#8E44AD" opacity="0.6" stroke="#2C3E50" stroke-width="0.8" rx="1"/>
        <rect x="224" y="0" width="28" height="26" fill="#8E44AD" opacity="0.6" stroke="#2C3E50" stroke-width="0.8" rx="1"/>
        <rect x="252" y="0" width="28" height="26" fill="#8E44AD" opacity="0.6" stroke="#2C3E50" stroke-width="0.8" rx="1"/>
        <rect x="280" y="0" width="28" height="26" fill="#8E44AD" opacity="0.6" stroke="#2C3E50" stroke-width="0.8" rx="1"/>
        <rect x="308" y="0" width="28" height="26" fill="#8E44AD" opacity="0.6" stroke="#2C3E50" stroke-width="0.8" rx="1"/>
        <rect x="336" y="0" width="28" height="26" fill="#8E44AD" opacity="0.6" stroke="#2C3E50" stroke-width="0.8" rx="1"/>
        <rect x="364" y="0" width="28" height="26" fill="#8E44AD" opacity="0.6" stroke="#2C3E50" stroke-width="0.8" rx="1"/>
        <rect x="392" y="0" width="28" height="26" fill="#8E44AD" opacity="0.6" stroke="#2C3E50" stroke-width="0.8" rx="1"/>
        <rect x="420" y="0" width="28" height="26" fill="#8E44AD" opacity="0.6" stroke="#2C3E50" stroke-width="0.8" rx="1"/>

        <!-- Thread labels -->
        <text x="7" y="17" class="tiny" fill="white" font-weight="bold">T0</text>
        <text x="35" y="17" class="tiny" fill="white" font-weight="bold">T1</text>
        <text x="63" y="17" class="tiny" fill="white" font-weight="bold">T2</text>
        <text x="200" y="17" class="tiny" fill="white" font-weight="bold">...</text>
        <text x="393" y="17" class="tiny" fill="white" font-weight="bold">T14</text>
        <text x="421" y="17" class="tiny" fill="white" font-weight="bold">T15</text>

        <text x="224" y="42" text-anchor="middle" class="tiny" fill="#666">ty=0: B[i, col0..col15] -- 16 consecutive floats (64B)</text>
      </g>

      <!-- Second half-warp (ty=1) reads SAME B addresses -->
      <g transform="translate(0, 60)">
        <rect x="0" y="0" width="448" height="26" fill="#8E44AD" opacity="0.3" stroke="#8E44AD" stroke-width="0.8" stroke-dasharray="3,2" rx="1"/>
        <text x="224" y="17" text-anchor="middle" class="tiny" fill="#8E44AD">ty=1: B[i, col0..col15] -- SAME 16 addresses as ty=0 (L1 hit)</text>
      </g>

      <!-- Memory layout -->
      <text x="0" y="108" class="subtitle">Global memory layout (row-major B):</text>
      <rect x="0" y="116" width="448" height="22" fill="#8E44AD" opacity="0.25" stroke="#8E44AD" rx="3"/>
      <text x="224" y="132" text-anchor="middle" class="small" fill="#333">B[i, col..col+15] -- 16 consecutive floats = 64 bytes</text>

      <!-- Verdict -->
      <rect x="0" y="148" width="448" height="26" fill="#D5F5E3" stroke="#27AE60" rx="4"/>
      <text x="224" y="166" text-anchor="middle" class="small" fill="#1E8449" font-weight="bold">Coalesced: 16 threads read 16 consecutive floats (2 x 32B transactions)</text>

      <text x="0" y="196" class="small" fill="#C0392B" font-weight="bold">BUT: these reads are in the inner loop (K iterations)</text>
      <text x="0" y="210" class="small" fill="#C0392B">Every element re-fetched from global memory every time -- no reuse!</text>
    </g>
  </g>

  <!-- ============================================================ -->
  <!-- SECTION 3: Compute Pattern                                   -->
  <!-- ============================================================ -->
  <line x1="40" y1="580" x2="1360" y2="580" stroke="#DDD" stroke-width="1"/>
  <text x="50" y="605" class="section-title">3. Compute Pattern -- Per Thread Inner Loop</text>

  <g transform="translate(60, 625)">
    <!-- Code box -->
    <rect x="0" y="0" width="380" height="105" fill="white" stroke="#DDD" stroke-width="1" rx="6"/>
    <text x="190" y="20" text-anchor="middle" class="subtitle">Inner Loop (one thread)</text>
    <line x1="10" y1="28" x2="370" y2="28" stroke="#EEE"/>
    <text x="15" y="46" class="code">float sum = 0.0f;</text>
    <text x="15" y="62" class="code">for (int i = 0; i &lt; K; i++) {</text>
    <text x="15" y="78" class="code">    sum += A[row*K + i] * B[i*N + col]; // 2 loads, 1 FMA</text>
    <text x="15" y="94" class="code">}</text>

    <!-- Stats box -->
    <g transform="translate(410, 0)">
      <rect x="0" y="0" width="380" height="105" fill="white" stroke="#DDD" stroke-width="1" rx="6"/>
      <text x="190" y="20" text-anchor="middle" class="subtitle">Per-Thread Stats</text>
      <line x1="10" y1="28" x2="370" y2="28" stroke="#EEE"/>
      <text x="15" y="48" class="code" fill="#4A90D9">Global loads from A:  K</text>
      <text x="15" y="64" class="code" fill="#27AE60">Global loads from B:  K</text>
      <text x="15" y="80" class="code" fill="#E67E22">FMA operations:       K</text>
      <line x1="10" y1="88" x2="370" y2="88" stroke="#EEE"/>
      <text x="15" y="102" class="code bold" fill="#C0392B">Ratio: 2 loads per 1 FMA = 0.5 compute:load</text>
    </g>

    <!-- Block-level stats -->
    <g transform="translate(820, 0)">
      <rect x="0" y="0" width="380" height="105" fill="white" stroke="#DDD" stroke-width="1" rx="6"/>
      <text x="190" y="20" text-anchor="middle" class="subtitle">Per-Block Stats (16x16 = 256 threads)</text>
      <line x1="10" y1="28" x2="370" y2="28" stroke="#EEE"/>
      <text x="15" y="48" class="code">Total global loads: 256 * 2K = 512K</text>
      <text x="15" y="64" class="code">Total FMAs:         256 * K  = 256K</text>
      <text x="15" y="80" class="code">Bytes loaded:       512K * 4 = 2048K bytes</text>
      <line x1="10" y1="88" x2="370" y2="88" stroke="#EEE"/>
      <text x="15" y="102" class="code bold" fill="#C0392B">~8 bytes per FLOP (terrible!)</text>
    </g>
  </g>

  <!-- ============================================================ -->
  <!-- SECTION 4: Why This Is Slow                                  -->
  <!-- ============================================================ -->
  <line x1="40" y1="755" x2="1360" y2="755" stroke="#DDD" stroke-width="1"/>
  <text x="50" y="780" class="section-title">4. Why This Is Slow -- No Data Reuse</text>

  <g transform="translate(60, 800)">
    <!-- A reuse problem -->
    <g transform="translate(0, 0)">
      <rect x="0" y="0" width="420" height="145" fill="#FADBD8" stroke="#C0392B" stroke-width="1" rx="6"/>
      <text x="210" y="20" text-anchor="middle" class="subtitle" fill="#C0392B">A[row][i] loaded redundantly</text>
      <line x1="10" y1="28" x2="410" y2="28" stroke="#E6B0AA"/>

      <!-- Show 16 threads in a row all needing same A element -->
      <text x="15" y="46" class="code">Thread (ty, tx=0): reads A[row, i]</text>
      <text x="15" y="60" class="code">Thread (ty, tx=1): reads A[row, i]  ← SAME!</text>
      <text x="15" y="74" class="code">Thread (ty, tx=2): reads A[row, i]  ← SAME!</text>
      <text x="15" y="88" class="code">...</text>
      <text x="15" y="102" class="code">Thread (ty, tx=15): reads A[row, i] ← SAME!</text>
      <line x1="10" y1="112" x2="410" y2="112" stroke="#E6B0AA"/>
      <text x="15" y="130" class="code bold" fill="#C0392B">16x redundant: A element loaded by 16 threads</text>
    </g>

    <!-- B reuse problem -->
    <g transform="translate(450, 0)">
      <rect x="0" y="0" width="420" height="145" fill="#FADBD8" stroke="#C0392B" stroke-width="1" rx="6"/>
      <text x="210" y="20" text-anchor="middle" class="subtitle" fill="#C0392B">B[i][col] loaded redundantly</text>
      <line x1="10" y1="28" x2="410" y2="28" stroke="#E6B0AA"/>

      <!-- Show 16 threads in a column all needing same B element -->
      <text x="15" y="46" class="code">Thread (ty=0, tx): reads B[i, col]</text>
      <text x="15" y="60" class="code">Thread (ty=1, tx): reads B[i, col]  ← SAME!</text>
      <text x="15" y="74" class="code">Thread (ty=2, tx): reads B[i, col]  ← SAME!</text>
      <text x="15" y="88" class="code">...</text>
      <text x="15" y="102" class="code">Thread (ty=15, tx): reads B[i, col] ← SAME!</text>
      <line x1="10" y1="112" x2="410" y2="112" stroke="#E6B0AA"/>
      <text x="15" y="130" class="code bold" fill="#C0392B">16x redundant: B element loaded by 16 threads</text>
    </g>

    <!-- Bandwidth comparison box -->
    <g transform="translate(900, 0)">
      <rect x="0" y="0" width="380" height="145" fill="white" stroke="#333" stroke-width="1.5" rx="6"/>
      <text x="190" y="22" text-anchor="middle" class="subtitle">Bandwidth Bottleneck</text>
      <line x1="10" y1="30" x2="370" y2="30" stroke="#EEE"/>
      <text x="15" y="50" class="code">Required:  ~8 bytes/FLOP</text>
      <text x="15" y="68" class="code">Hardware:  ~0.1 bytes/FLOP</text>
      <text x="15" y="88" class="small" fill="#555">(e.g. A100: 2TB/s BW, 19.5 TFLOPS FP32)</text>
      <line x1="10" y1="98" x2="370" y2="98" stroke="#EEE"/>
      <text x="15" y="118" class="code bold" fill="#C0392B">80x more bandwidth needed than</text>
      <text x="15" y="134" class="code bold" fill="#C0392B">available -- severely memory bound</text>
    </g>
  </g>

  <!-- ============================================================ -->
  <!-- SECTION 5: Data Flow Summary                                 -->
  <!-- ============================================================ -->
  <line x1="40" y1="970" x2="1360" y2="970" stroke="#DDD" stroke-width="1"/>
  <text x="50" y="995" class="section-title">5. Data Flow Summary</text>

  <g transform="translate(80, 1020)">
    <!-- Pipeline stages -->
    <!-- Stage 1: Global A -->
    <rect x="0" y="0" width="220" height="75" fill="#EBF5FB" stroke="#4A90D9" stroke-width="2" rx="8"/>
    <text x="110" y="20" text-anchor="middle" class="subtitle" fill="#4A90D9">Global Memory (A)</text>
    <text x="15" y="40" class="code">A[row * K + i]</text>
    <text x="15" y="56" class="code">1 float per iteration</text>

    <!-- Arrow -->
    <path d="M230,37 L270,37" class="arrow-bold"/>

    <!-- Stage 2: Register -->
    <rect x="280" y="0" width="180" height="75" fill="#ECF0F1" stroke="#95A5A6" stroke-width="2" rx="8"/>
    <text x="370" y="20" text-anchor="middle" class="subtitle" fill="#555">Register</text>
    <text x="290" y="40" class="code">float a_val</text>
    <text x="290" y="56" class="code">float b_val</text>

    <!-- Arrow -->
    <path d="M470,37 L510,37" class="arrow-bold"/>

    <!-- Stage 3: FMA -->
    <rect x="520" y="0" width="180" height="75" fill="url(#fma-grad)" opacity="0.5" stroke="#E74C3C" stroke-width="2" rx="8"/>
    <text x="610" y="20" text-anchor="middle" class="subtitle" fill="#E74C3C">FMA (Compute)</text>
    <text x="530" y="40" class="code">sum += a * b</text>
    <text x="530" y="56" class="code">1 FMA per step</text>

    <!-- Arrow -->
    <path d="M710,37 L750,37" class="arrow-bold"/>

    <!-- Stage 4: Register accumulator -->
    <rect x="760" y="0" width="180" height="75" fill="#ECF0F1" stroke="#95A5A6" stroke-width="2" rx="8"/>
    <text x="850" y="20" text-anchor="middle" class="subtitle" fill="#555">Register (accum)</text>
    <text x="770" y="40" class="code">float sum</text>
    <text x="770" y="56" class="code">(persists K iters)</text>

    <!-- Arrow -->
    <path d="M950,37 L990,37" class="arrow-bold"/>

    <!-- Stage 5: Global C -->
    <rect x="1000" y="0" width="220" height="75" fill="#D5F5E3" stroke="#27AE60" stroke-width="2" rx="8"/>
    <text x="1110" y="20" text-anchor="middle" class="subtitle" fill="#27AE60">Global Memory (C)</text>
    <text x="1010" y="40" class="code">C[row * N + col] = sum</text>
    <text x="1010" y="56" class="code">1 store at the end</text>

    <!-- Global B arrow into register -->
    <rect x="0" y="90" width="220" height="45" fill="#EBF5FB" stroke="#27AE60" stroke-width="2" rx="8"/>
    <text x="110" y="110" text-anchor="middle" class="subtitle" fill="#27AE60">Global Memory (B)</text>
    <text x="15" y="126" class="code">B[i * N + col], 1 float/iter</text>
    <path d="M230,112 L370,82" class="arrow-bold"/>

    <!-- Key insight box -->
    <g transform="translate(280, 90)">
      <rect x="0" y="0" width="720" height="50" fill="white" stroke="#333" stroke-width="1.5" rx="6"/>
      <text x="360" y="20" text-anchor="middle" class="subtitle">Key: No Intermediate Storage (No Shared Memory, No Tiling)</text>
      <text x="15" y="38" class="code">Global A → Reg → FMA → Reg → Global C  |  Global B → Reg → FMA   (simplest possible pipeline)</text>
    </g>
  </g>

  <!-- Footer -->
  <text x="700" y="1185" text-anchor="middle" class="tiny" fill="#AAA">matmul_naive -- block(16,16), 1 thread = 1 output, no shared memory, no data reuse</text>
</svg>