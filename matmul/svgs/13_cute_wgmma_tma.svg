<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1400 2800" font-family="'Courier New', monospace">
  <style>
    .title { font-size: 22px; font-weight: bold; fill: #222; }
    .section-title { font-size: 17px; font-weight: bold; fill: #333; }
    .subtitle { font-size: 13px; font-weight: bold; fill: #555; }
    .label { font-size: 11px; fill: #333; }
    .small { font-size: 10px; fill: #555; }
    .tiny { font-size: 9px; fill: #666; }
    .code { font-size: 10px; fill: #333; font-family: monospace; }
    .bold { font-weight: bold; }
    .a-fill { fill: #4A90D9; }
    .a-light { fill: #CADFF5; }
    .b-fill { fill: #27AE60; }
    .b-light { fill: #B8E6CC; }
    .c-fill { fill: #E67E22; }
    .c-light { fill: #FDEBD0; }
    .warp-fill { fill: #F1C40F; opacity: 0.6; }
    .coalesced { fill: #8E44AD; }
    .coalesced-light { fill: #D7BDE2; }
    .strided { fill: #C0392B; }
    .reg-fill { fill: #ECF0F1; }
    .outline { fill: none; stroke: #333; stroke-width: 1; }
    .outline-bold { fill: none; stroke: #333; stroke-width: 2; }
    .arrow { fill: none; stroke: #555; stroke-width: 1.5; marker-end: url(#arrowhead); }
    .arrow-bold { fill: none; stroke: #333; stroke-width: 2; marker-end: url(#arrowhead); }
    .dashed { stroke-dasharray: 4,3; }
    .thread-grid { fill: #F9F9F9; stroke: #CCC; stroke-width: 0.5; }
    .broadcast { fill: #2ECC71; opacity: 0.3; }
    .bank-conflict { fill: #E74C3C; opacity: 0.3; }
    .dim-label { font-size: 11px; fill: #888; font-style: italic; }
    .tma-fill { fill: #9B59B6; }
    .tma-light { fill: #E8D5F5; }
    .barrier-fill { fill: #E74C3C; }
    .barrier-light { fill: #FADBD8; }
    .pipe-s0 { fill: #3498DB; }
    .pipe-s1 { fill: #27AE60; }
    .pipe-s2 { fill: #E67E22; }
  </style>
  <defs>
    <marker id="arrowhead" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto">
      <path d="M0,0 L8,3 L0,6 Z" fill="#555"/>
    </marker>
    <marker id="arrowhead-red" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto">
      <path d="M0,0 L8,3 L0,6 Z" fill="#C0392B"/>
    </marker>
    <marker id="arrowhead-purple" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto">
      <path d="M0,0 L8,3 L0,6 Z" fill="#9B59B6"/>
    </marker>
    <linearGradient id="fma-grad" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#F39C12;stop-opacity:0.8"/>
      <stop offset="100%" style="stop-color:#E74C3C;stop-opacity:0.8"/>
    </linearGradient>
    <linearGradient id="tma-grad" x1="0%" y1="0%" x2="100%" y2="0%">
      <stop offset="0%" style="stop-color:#8E44AD;stop-opacity:0.7"/>
      <stop offset="100%" style="stop-color:#3498DB;stop-opacity:0.7"/>
    </linearGradient>
  </defs>

  <!-- Background -->
  <rect width="1400" height="2800" fill="#FAFAFA" rx="8"/>

  <!-- ============================================================ -->
  <!-- TITLE                                                         -->
  <!-- ============================================================ -->
  <text x="700" y="35" text-anchor="middle" class="title">SM90 WGMMA + TMA: Memory Access &amp; Compute Patterns</text>
  <text x="700" y="55" text-anchor="middle" class="small">BLK_M=128, BLK_N=128, BLK_K=32, PIPE=3, SM90_64x128x8_F32TF32TF32_SS_TN tiled 2x1x1, 256 threads (2 warp groups), TMA hardware loads</text>

  <!-- ============================================================ -->
  <!-- SECTION 1: TMA (Tensor Memory Accelerator)                   -->
  <!-- ============================================================ -->
  <line x1="40" y1="70" x2="1360" y2="70" stroke="#DDD" stroke-width="1"/>
  <text x="50" y="95" class="section-title">1. TMA (Tensor Memory Accelerator) -- Hardware Data Movement</text>

  <!-- TMA overview diagram -->
  <g transform="translate(60, 115)">
    <!-- The "1 thread" box -->
    <rect x="0" y="0" width="160" height="70" fill="#E8D5F5" stroke="#9B59B6" stroke-width="2" rx="6"/>
    <text x="80" y="20" text-anchor="middle" class="subtitle" fill="#9B59B6">Thread 0 (Warp 0)</text>
    <text x="80" y="38" text-anchor="middle" class="code">warp_idx == 0 &amp;&amp;</text>
    <text x="80" y="52" text-anchor="middle" class="code">lane_predicate</text>
    <text x="80" y="65" text-anchor="middle" class="tiny" fill="#9B59B6">Only this thread issues TMA</text>

    <!-- Arrow: Thread 0 -> TMA Unit -->
    <path d="M160,35 L210,35" class="arrow-bold" stroke="#9B59B6" marker-end="url(#arrowhead-purple)"/>
    <text x="185" y="28" text-anchor="middle" class="tiny" fill="#9B59B6">issues</text>

    <!-- TMA Hardware Unit -->
    <rect x="210" y="0" width="200" height="70" fill="#9B59B6" opacity="0.15" stroke="#9B59B6" stroke-width="2" rx="6"/>
    <text x="310" y="20" text-anchor="middle" class="subtitle" fill="#9B59B6">TMA Hardware Unit</text>
    <text x="310" y="36" text-anchor="middle" class="code" fill="#555">Address calculation</text>
    <text x="310" y="48" text-anchor="middle" class="code" fill="#555">Bounds checking</text>
    <text x="310" y="60" text-anchor="middle" class="code" fill="#555">Data movement</text>

    <!-- Arrow: TMA -> Global DRAM -->
    <path d="M310,70 L310,100" class="arrow-bold" stroke="#9B59B6" marker-end="url(#arrowhead-purple)"/>

    <!-- Global DRAM -->
    <rect x="230" y="100" width="160" height="35" fill="#DDD" stroke="#888" stroke-width="1.5" rx="4"/>
    <text x="310" y="122" text-anchor="middle" class="small bold">Global DRAM</text>

    <!-- Arrow: DRAM -> L2 -->
    <path d="M390,117 L440,117" class="arrow-bold"/>

    <!-- L2 Cache -->
    <rect x="440" y="100" width="100" height="35" fill="#ECF0F1" stroke="#888" stroke-width="1.5" rx="4"/>
    <text x="490" y="122" text-anchor="middle" class="small bold">L2 Cache</text>

    <!-- Arrow: L2 -> Swizzled SMEM -->
    <path d="M540,117 L590,117" class="arrow-bold"/>

    <!-- Swizzled Shared Memory -->
    <rect x="590" y="85" width="220" height="65" fill="#CADFF5" stroke="#4A90D9" stroke-width="2" rx="6"/>
    <text x="700" y="105" text-anchor="middle" class="subtitle" fill="#4A90D9">Swizzled Shared Memory</text>
    <text x="700" y="120" text-anchor="middle" class="code">sA: (128, 32, 3) sw128</text>
    <text x="700" y="134" text-anchor="middle" class="code">sB: (128, 32, 3) sw128</text>

    <!-- The rest of threads -->
    <rect x="0" y="85" width="160" height="50" fill="#FDEBD0" stroke="#E67E22" stroke-width="2" rx="6"/>
    <text x="80" y="103" text-anchor="middle" class="subtitle" fill="#E67E22">Other 255 Threads</text>
    <text x="80" y="118" text-anchor="middle" class="code">Do NO load work</text>
    <text x="80" y="130" text-anchor="middle" class="tiny" fill="#E67E22">100% dedicated to WGMMA</text>

    <!-- Key differences box -->
    <g transform="translate(850, 0)">
      <rect x="0" y="0" width="470" height="150" fill="white" stroke="#9B59B6" stroke-width="1.5" rx="6"/>
      <text x="235" y="20" text-anchor="middle" class="subtitle" fill="#9B59B6">TMA vs. Traditional Loading</text>
      <line x1="10" y1="28" x2="460" y2="28" stroke="#EEE"/>
      <text x="15" y="46" class="code" fill="#C0392B">Traditional (cp_async): All 256 threads cooperate</text>
      <text x="15" y="60" class="code" fill="#C0392B">  - threads compute addresses, handle coalescing</text>
      <text x="15" y="74" class="code" fill="#C0392B">  - wasted compute on load bookkeeping</text>
      <line x1="15" y1="82" x2="450" y2="82" stroke="#EEE"/>
      <text x="15" y="98" class="code" fill="#1E8449">TMA: 1 thread issues, hardware does the rest</text>
      <text x="15" y="112" class="code" fill="#1E8449">  - no address calc, no coalescing concerns</text>
      <text x="15" y="126" class="code" fill="#1E8449">  - 255 threads free for compute</text>
      <text x="15" y="142" class="code" fill="#1E8449">  - direct DRAM -> L2 -> swizzled SMEM path</text>
    </g>

    <!-- TMA descriptor note -->
    <g transform="translate(440, 0)">
      <rect x="0" y="0" width="370" height="70" fill="#FCF3CF" stroke="#F1C40F" stroke-width="1" rx="4"/>
      <text x="185" y="18" text-anchor="middle" class="small bold" fill="#7D6608">TMA Descriptor (created on host):</text>
      <text x="10" y="34" class="code" fill="#7D6608">make_tma_atom(SM90_TMA_LOAD{}, tensor,</text>
      <text x="10" y="48" class="code" fill="#7D6608">  smem_layout, tile_shape)</text>
      <text x="10" y="62" class="code" fill="#7D6608">Encodes: layout + swizzle + tile dims</text>
    </g>
  </g>

  <!-- ============================================================ -->
  <!-- SECTION 2: Multi-Stage Pipeline (PIPE=3)                     -->
  <!-- ============================================================ -->
  <line x1="40" y1="290" x2="1360" y2="290" stroke="#DDD" stroke-width="1"/>
  <text x="50" y="315" class="section-title">2. Multi-Stage Pipeline (PIPE=3)</text>

  <g transform="translate(60, 340)">
    <!-- Three SMEM stage boxes -->
    <text x="0" y="0" class="subtitle">Shared Memory Layout: sA/sB have 3 copies (stages 0, 1, 2)</text>

    <!-- Stage 0 -->
    <rect x="0" y="15" width="350" height="55" fill="#3498DB" opacity="0.15" stroke="#3498DB" stroke-width="2" rx="6"/>
    <text x="175" y="35" text-anchor="middle" class="subtitle" fill="#3498DB">Stage 0: sA(_,_,0) + sB(_,_,0)</text>
    <text x="175" y="52" text-anchor="middle" class="code">128x32 A tile + 128x32 B tile (sw128)</text>

    <!-- Stage 1 -->
    <rect x="370" y="15" width="350" height="55" fill="#27AE60" opacity="0.15" stroke="#27AE60" stroke-width="2" rx="6"/>
    <text x="545" y="35" text-anchor="middle" class="subtitle" fill="#27AE60">Stage 1: sA(_,_,1) + sB(_,_,1)</text>
    <text x="545" y="52" text-anchor="middle" class="code">128x32 A tile + 128x32 B tile (sw128)</text>

    <!-- Stage 2 -->
    <rect x="740" y="15" width="350" height="55" fill="#E67E22" opacity="0.15" stroke="#E67E22" stroke-width="2" rx="6"/>
    <text x="915" y="35" text-anchor="middle" class="subtitle" fill="#E67E22">Stage 2: sA(_,_,2) + sB(_,_,2)</text>
    <text x="915" y="52" text-anchor="middle" class="code">128x32 A tile + 128x32 B tile (sw128)</text>

    <!-- Prologue -->
    <text x="0" y="95" class="subtitle">Prologue: Fill ALL 3 stages before main loop starts</text>
    <g transform="translate(20, 108)">
      <!-- Three load boxes -->
      <rect x="0" y="0" width="200" height="30" fill="#3498DB" opacity="0.3" stroke="#3498DB" stroke-width="1.5" rx="4"/>
      <text x="100" y="20" text-anchor="middle" class="code bold" fill="#2C3E50">TMA Load k=0 -> Stage 0</text>

      <rect x="220" y="0" width="200" height="30" fill="#27AE60" opacity="0.3" stroke="#27AE60" stroke-width="1.5" rx="4"/>
      <text x="320" y="20" text-anchor="middle" class="code bold" fill="#2C3E50">TMA Load k=1 -> Stage 1</text>

      <rect x="440" y="0" width="200" height="30" fill="#E67E22" opacity="0.3" stroke="#E67E22" stroke-width="1.5" rx="4"/>
      <text x="540" y="20" text-anchor="middle" class="code bold" fill="#2C3E50">TMA Load k=2 -> Stage 2</text>

      <!-- Arrows between -->
      <path d="M200,15 L220,15" stroke="#555" stroke-width="1.5" marker-end="url(#arrowhead)"/>
      <path d="M420,15 L440,15" stroke="#555" stroke-width="1.5" marker-end="url(#arrowhead)"/>
    </g>

    <!-- Main loop illustration -->
    <text x="0" y="167" class="subtitle">Main Loop: consume one stage while filling another (2 stages buffered)</text>
    <g transform="translate(20, 180)">
      <!-- Table header -->
      <text x="0" y="0" class="code bold" fill="#555">Iteration</text>
      <text x="130" y="0" class="code bold" fill="#E67E22">WGMMA reads (all 256 threads)</text>
      <text x="480" y="0" class="code bold" fill="#9B59B6">TMA writes (thread 0 only)</text>

      <!-- Row 0 -->
      <rect x="0" y="8" width="820" height="18" fill="#3498DB" opacity="0.08" rx="2"/>
      <text x="0" y="22" class="code">k=0:</text>
      <text x="130" y="22" class="code" fill="#2980B9">Read Stage 0 (wgmma)</text>
      <text x="480" y="22" class="code" fill="#8E44AD">Load k=3 -> Stage 0 (refill)</text>
      <!-- Row 1 -->
      <rect x="0" y="26" width="820" height="18" fill="#27AE60" opacity="0.08" rx="2"/>
      <text x="0" y="40" class="code">k=1:</text>
      <text x="130" y="40" class="code" fill="#27AE60">Read Stage 1 (wgmma)</text>
      <text x="480" y="40" class="code" fill="#8E44AD">Load k=4 -> Stage 1 (refill)</text>
      <!-- Row 2 -->
      <rect x="0" y="44" width="820" height="18" fill="#E67E22" opacity="0.08" rx="2"/>
      <text x="0" y="58" class="code">k=2:</text>
      <text x="130" y="58" class="code" fill="#E67E22">Read Stage 2 (wgmma)</text>
      <text x="480" y="58" class="code" fill="#8E44AD">Load k=5 -> Stage 2 (refill)</text>
      <!-- Row 3 -->
      <rect x="0" y="62" width="820" height="18" fill="#3498DB" opacity="0.08" rx="2"/>
      <text x="0" y="76" class="code">k=3:</text>
      <text x="130" y="76" class="code" fill="#2980B9">Read Stage 0 (wgmma)</text>
      <text x="480" y="76" class="code" fill="#8E44AD">Load k=6 -> Stage 0 (refill)</text>
      <!-- Row 4 -->
      <text x="0" y="94" class="code" fill="#888">...</text>
      <text x="130" y="94" class="code" fill="#888">(cycles through stages 0,1,2,0,1,2,...)</text>
    </g>

    <!-- Benefit note -->
    <rect x="0" y="290" width="600" height="28" fill="#D5F5E3" stroke="#27AE60" rx="4"/>
    <text x="300" y="309" text-anchor="middle" class="small" fill="#1E8449" font-weight="bold">3 stages = 2 stages of lookahead: TMA latency hidden behind 2 WGMMA iterations</text>
  </g>

  <!-- ============================================================ -->
  <!-- SECTION 3: Barrier-Based Producer-Consumer Synchronization   -->
  <!-- ============================================================ -->
  <line x1="40" y1="670" x2="1360" y2="670" stroke="#DDD" stroke-width="1"/>
  <text x="50" y="695" class="section-title">3. Barrier-Based Producer-Consumer Synchronization</text>

  <g transform="translate(60, 720)">
    <!-- Two barrier arrays side by side -->

    <!-- Producer barriers (TMA) -->
    <rect x="0" y="0" width="580" height="170" fill="white" stroke="#9B59B6" stroke-width="2" rx="6"/>
    <text x="290" y="22" text-anchor="middle" class="subtitle" fill="#9B59B6">tma_barrier[3] -- Producer Barriers (ClusterTransactionBarrier)</text>
    <line x1="10" y1="30" x2="570" y2="30" stroke="#EEE"/>

    <!-- Three barrier slots -->
    <g transform="translate(20, 42)">
      <rect x="0" y="0" width="160" height="40" fill="#3498DB" opacity="0.15" stroke="#3498DB" stroke-width="1.5" rx="4"/>
      <text x="80" y="16" text-anchor="middle" class="code bold" fill="#3498DB">tma_barrier[0]</text>
      <text x="80" y="32" text-anchor="middle" class="tiny" fill="#3498DB">Stage 0 ready?</text>

      <rect x="180" y="0" width="160" height="40" fill="#27AE60" opacity="0.15" stroke="#27AE60" stroke-width="1.5" rx="4"/>
      <text x="260" y="16" text-anchor="middle" class="code bold" fill="#27AE60">tma_barrier[1]</text>
      <text x="260" y="32" text-anchor="middle" class="tiny" fill="#27AE60">Stage 1 ready?</text>

      <rect x="360" y="0" width="160" height="40" fill="#E67E22" opacity="0.15" stroke="#E67E22" stroke-width="1.5" rx="4"/>
      <text x="440" y="16" text-anchor="middle" class="code bold" fill="#E67E22">tma_barrier[2]</text>
      <text x="440" y="32" text-anchor="middle" class="tiny" fill="#E67E22">Stage 2 ready?</text>
    </g>

    <text x="20" y="100" class="code" fill="#9B59B6">TMA signals: arrive_and_expect_tx(&amp;tma_barrier[pipe], bytes)</text>
    <text x="20" y="116" class="code" fill="#333">WGMMA waits: ProducerBarType::wait(&amp;tma_barrier[pipe], phase)</text>
    <text x="20" y="136" class="small" fill="#555">TMA announces expected transaction bytes; barrier auto-completes when</text>
    <text x="20" y="150" class="small" fill="#555">hardware confirms all bytes have arrived in shared memory.</text>

    <!-- Consumer barriers (MMA) -->
    <rect x="600" y="0" width="580" height="170" fill="white" stroke="#E74C3C" stroke-width="2" rx="6"/>
    <text x="890" y="22" text-anchor="middle" class="subtitle" fill="#E74C3C">mma_barrier[3] -- Consumer Barriers (ClusterBarrier)</text>
    <line x1="610" y1="30" x2="1170" y2="30" stroke="#EEE"/>

    <g transform="translate(620, 42)">
      <rect x="0" y="0" width="160" height="40" fill="#3498DB" opacity="0.15" stroke="#3498DB" stroke-width="1.5" rx="4"/>
      <text x="80" y="16" text-anchor="middle" class="code bold" fill="#3498DB">mma_barrier[0]</text>
      <text x="80" y="32" text-anchor="middle" class="tiny" fill="#3498DB">Stage 0 consumed?</text>

      <rect x="180" y="0" width="160" height="40" fill="#27AE60" opacity="0.15" stroke="#27AE60" stroke-width="1.5" rx="4"/>
      <text x="260" y="16" text-anchor="middle" class="code bold" fill="#27AE60">mma_barrier[1]</text>
      <text x="260" y="32" text-anchor="middle" class="tiny" fill="#27AE60">Stage 1 consumed?</text>

      <rect x="360" y="0" width="160" height="40" fill="#E67E22" opacity="0.15" stroke="#E67E22" stroke-width="1.5" rx="4"/>
      <text x="440" y="16" text-anchor="middle" class="code bold" fill="#E67E22">mma_barrier[2]</text>
      <text x="440" y="32" text-anchor="middle" class="tiny" fill="#E67E22">Stage 2 consumed?</text>
    </g>

    <text x="620" y="100" class="code" fill="#E74C3C">WGMMA signals: ConsumerBarType::arrive(&amp;mma_barrier[pipe])</text>
    <text x="620" y="116" class="code" fill="#333">TMA waits:    ConsumerBarType::wait(&amp;mma_barrier[pipe], phase)</text>
    <text x="620" y="136" class="small" fill="#555">All 256 threads signal arrival when done consuming a stage.</text>
    <text x="620" y="150" class="small" fill="#555">TMA thread waits before reusing that stage for next tile.</text>

    <!-- Phase tracking note -->
    <rect x="0" y="185" width="1180" height="45" fill="#FCF3CF" stroke="#F1C40F" stroke-width="1" rx="4"/>
    <text x="590" y="205" text-anchor="middle" class="small bold" fill="#7D6608">Phase Tracking: Barriers toggle phase bits each epoch to prevent race conditions on stage reuse.</text>
    <text x="590" y="220" text-anchor="middle" class="small" fill="#7D6608">This is hardware barrier sync, NOT __syncthreads() -- only producing/consuming threads synchronize, minimal overhead.</text>

    <!-- Synchronization flow diagram -->
    <g transform="translate(0, 245)">
      <text x="0" y="0" class="subtitle">Synchronization Flow (one iteration):</text>

      <!-- TMA Producer side -->
      <rect x="0" y="18" width="200" height="32" fill="#9B59B6" opacity="0.2" stroke="#9B59B6" stroke-width="1.5" rx="4"/>
      <text x="100" y="38" text-anchor="middle" class="code bold" fill="#9B59B6">TMA Load -> Stage N</text>

      <path d="M200,34 L260,34" stroke="#9B59B6" stroke-width="1.5" marker-end="url(#arrowhead-purple)"/>
      <text x="230" y="26" text-anchor="middle" class="tiny" fill="#9B59B6">signal</text>

      <rect x="260" y="18" width="180" height="32" fill="#9B59B6" opacity="0.1" stroke="#9B59B6" stroke-width="1" rx="4"/>
      <text x="350" y="38" text-anchor="middle" class="code" fill="#9B59B6">tma_barrier[N]</text>

      <path d="M440,34 L500,34" stroke="#555" stroke-width="1.5" marker-end="url(#arrowhead)"/>
      <text x="470" y="26" text-anchor="middle" class="tiny">wait</text>

      <!-- WGMMA Consumer side -->
      <rect x="500" y="18" width="200" height="32" fill="#E67E22" opacity="0.2" stroke="#E67E22" stroke-width="1.5" rx="4"/>
      <text x="600" y="38" text-anchor="middle" class="code bold" fill="#E67E22">WGMMA on Stage N</text>

      <path d="M700,34 L760,34" stroke="#E74C3C" stroke-width="1.5" marker-end="url(#arrowhead-red)"/>
      <text x="730" y="26" text-anchor="middle" class="tiny" fill="#E74C3C">signal</text>

      <rect x="760" y="18" width="180" height="32" fill="#E74C3C" opacity="0.1" stroke="#E74C3C" stroke-width="1" rx="4"/>
      <text x="850" y="38" text-anchor="middle" class="code" fill="#E74C3C">mma_barrier[N]</text>

      <path d="M940,34 L1000,34" stroke="#555" stroke-width="1.5" marker-end="url(#arrowhead)"/>
      <text x="970" y="26" text-anchor="middle" class="tiny">wait</text>

      <!-- Recycle arrow -->
      <rect x="1000" y="18" width="170" height="32" fill="#9B59B6" opacity="0.2" stroke="#9B59B6" stroke-width="1.5" rx="4"/>
      <text x="1085" y="38" text-anchor="middle" class="code bold" fill="#9B59B6">TMA Refill Stage N</text>
    </g>
  </g>

  <!-- ============================================================ -->
  <!-- SECTION 4: WGMMA Compute                                     -->
  <!-- ============================================================ -->
  <line x1="40" y1="1040" x2="1360" y2="1040" stroke="#DDD" stroke-width="1"/>
  <text x="50" y="1065" class="section-title">4. WGMMA Compute (SM90_64x128x8_F32TF32TF32_SS_TN, tiled 2x1x1)</text>

  <g transform="translate(60, 1085)">
    <!-- MMA atom diagram -->
    <!-- A tile -->
    <g transform="translate(0, 0)">
      <text x="30" y="-5" text-anchor="middle" class="subtitle" fill="#4A90D9">sA stage</text>
      <rect width="40" height="160" class="a-light" stroke="#4A90D9" stroke-width="2" rx="2"/>
      <text x="-10" y="8" text-anchor="end" class="tiny">0</text>
      <text x="-10" y="82" text-anchor="end" class="tiny">64</text>
      <text x="-10" y="158" text-anchor="end" class="tiny">127</text>
      <text x="20" y="176" text-anchor="middle" class="dim-label">32</text>
      <text x="-22" y="80" text-anchor="middle" class="dim-label" transform="rotate(-90,-22,80)">128 rows</text>
      <!-- Warp group 0 highlight -->
      <rect width="40" height="80" fill="#F1C40F" opacity="0.35" rx="1"/>
      <text x="20" y="40" text-anchor="middle" class="tiny" fill="#333">WG0</text>
      <!-- Warp group 1 -->
      <rect y="80" width="40" height="80" fill="#3498DB" opacity="0.2" rx="1"/>
      <text x="20" y="120" text-anchor="middle" class="tiny" fill="#333">WG1</text>
      <!-- K subdivisions -->
      <line x1="0" y1="0" x2="40" y2="0" stroke="#4A90D9" stroke-width="0.5" opacity="0.4"/>
      <line x1="10" y1="0" x2="10" y2="160" stroke="#4A90D9" stroke-width="0.3" opacity="0.3"/>
      <line x1="20" y1="0" x2="20" y2="160" stroke="#4A90D9" stroke-width="0.3" opacity="0.3"/>
      <line x1="30" y1="0" x2="30" y2="160" stroke="#4A90D9" stroke-width="0.3" opacity="0.3"/>
    </g>

    <!-- Multiply sign -->
    <text x="60" y="85" text-anchor="middle" font-size="22" fill="#333">x</text>

    <!-- B tile -->
    <g transform="translate(80, 55)">
      <text x="80" y="-60" text-anchor="middle" class="subtitle" fill="#27AE60">sB stage</text>
      <rect width="160" height="40" class="b-light" stroke="#27AE60" stroke-width="2" rx="2"/>
      <text x="2" y="55" text-anchor="start" class="tiny">0</text>
      <text x="78" y="55" text-anchor="middle" class="tiny">64</text>
      <text x="155" y="55" text-anchor="end" class="tiny">127</text>
      <text x="80" y="68" text-anchor="middle" class="dim-label">128 cols</text>
      <text x="-15" y="20" text-anchor="middle" class="dim-label" transform="rotate(-90,-15,20)">32</text>
      <!-- K subdivisions -->
      <line x1="0" y1="10" x2="160" y2="10" stroke="#27AE60" stroke-width="0.3" opacity="0.3"/>
      <line x1="0" y1="20" x2="160" y2="20" stroke="#27AE60" stroke-width="0.3" opacity="0.3"/>
      <line x1="0" y1="30" x2="160" y2="30" stroke="#27AE60" stroke-width="0.3" opacity="0.3"/>
    </g>

    <!-- Equals sign -->
    <text x="268" y="85" text-anchor="middle" font-size="22" fill="#333">=</text>

    <!-- C tile -->
    <g transform="translate(290, 0)">
      <text x="80" y="-5" text-anchor="middle" class="subtitle" fill="#E67E22">C accumulator (regs)</text>
      <rect width="160" height="160" class="c-light" stroke="#E67E22" stroke-width="2" rx="2"/>
      <!-- WG0 / WG1 split -->
      <rect width="160" height="80" fill="#F1C40F" opacity="0.2" rx="1"/>
      <text x="80" y="40" text-anchor="middle" class="small" fill="#333">Warp Group 0: rows 0-63</text>
      <rect y="80" width="160" height="80" fill="#3498DB" opacity="0.1" rx="1"/>
      <text x="80" y="120" text-anchor="middle" class="small" fill="#333">Warp Group 1: rows 64-127</text>
      <text x="80" y="176" text-anchor="middle" class="dim-label">128x128 output</text>
    </g>

    <!-- Stats box -->
    <g transform="translate(500, 0)">
      <rect x="0" y="0" width="460" height="200" fill="white" stroke="#DDD" stroke-width="1" rx="6"/>
      <text x="230" y="22" text-anchor="middle" class="subtitle">WGMMA Compute Details</text>
      <line x1="10" y1="30" x2="450" y2="30" stroke="#EEE"/>

      <text x="15" y="48" class="code bold" fill="#9B59B6">MMA Atom: SM90_64x128x8_F32TF32TF32_SS_TN</text>
      <text x="15" y="64" class="code">  64 M-rows x 128 N-cols x 8 K-steps per atom</text>
      <text x="15" y="80" class="code">  SS = both A,B read from shared memory (descriptors)</text>
      <text x="15" y="96" class="code">  TN = A transposed, B normal</text>
      <line x1="15" y1="104" x2="440" y2="104" stroke="#EEE"/>

      <text x="15" y="120" class="code bold">Tiled 2x1x1: 2 warp groups (8 warps, 256 threads)</text>
      <text x="15" y="136" class="code">  WG0 computes C[0:63, 0:127]</text>
      <text x="15" y="150" class="code">  WG1 computes C[64:127, 0:127]</text>
      <line x1="15" y1="158" x2="440" y2="158" stroke="#EEE"/>

      <text x="15" y="174" class="code" fill="#E67E22">Per k-tile: K=32, atom K=8 => 4 atoms per tile</text>
      <text x="15" y="190" class="code" fill="#E67E22">FMAs per k-tile: 128*128*32 = 524,288</text>
    </g>

    <!-- WGMMA flow -->
    <g transform="translate(0, 210)">
      <text x="0" y="0" class="subtitle">WGMMA Execution Sequence (per stage):</text>
      <g transform="translate(20, 15)">
        <rect x="0" y="0" width="160" height="28" fill="#3498DB" opacity="0.2" stroke="#3498DB" stroke-width="1" rx="4"/>
        <text x="80" y="18" text-anchor="middle" class="code bold" fill="#2980B9">warpgroup_arrive()</text>

        <path d="M160,14 L180,14" stroke="#555" stroke-width="1.2" marker-end="url(#arrowhead)"/>

        <rect x="180" y="0" width="340" height="28" fill="url(#fma-grad)" opacity="0.2" stroke="#E67E22" stroke-width="1.5" rx="4"/>
        <text x="350" y="18" text-anchor="middle" class="code bold" fill="#C0392B">gemm(tiled_mma, sA[pipe], sB[pipe], C_regs)</text>

        <path d="M520,14 L540,14" stroke="#555" stroke-width="1.2" marker-end="url(#arrowhead)"/>

        <rect x="540" y="0" width="200" height="28" fill="#27AE60" opacity="0.2" stroke="#27AE60" stroke-width="1" rx="4"/>
        <text x="640" y="18" text-anchor="middle" class="code bold" fill="#27AE60">warpgroup_commit/wait</text>

        <path d="M740,14 L760,14" stroke="#555" stroke-width="1.2" marker-end="url(#arrowhead)"/>

        <rect x="760" y="0" width="200" height="28" fill="#E74C3C" opacity="0.2" stroke="#E74C3C" stroke-width="1" rx="4"/>
        <text x="860" y="18" text-anchor="middle" class="code bold" fill="#E74C3C">ConsumerBarrier::arrive</text>
      </g>
    </g>
  </g>

  <!-- ============================================================ -->
  <!-- SECTION 5: Full Pipeline Timeline Visualization               -->
  <!-- ============================================================ -->
  <line x1="40" y1="1360" x2="1360" y2="1360" stroke="#DDD" stroke-width="1"/>
  <text x="50" y="1385" class="section-title">5. Full Pipeline Timeline Visualization</text>

  <g transform="translate(60, 1405)">
    <!-- Time axis -->
    <text x="0" y="0" class="subtitle">Time --></text>
    <line x1="150" y1="-5" x2="1280" y2="-5" stroke="#888" stroke-width="1" marker-end="url(#arrowhead)"/>

    <!-- Thread 0 (TMA) row -->
    <text x="0" y="35" class="small bold" fill="#9B59B6">Thread 0</text>
    <text x="0" y="47" class="small" fill="#9B59B6">(TMA)</text>

    <!-- Prologue loads -->
    <rect x="150" y="20" width="100" height="35" fill="#3498DB" opacity="0.4" stroke="#3498DB" stroke-width="1.5" rx="3"/>
    <text x="200" y="42" text-anchor="middle" class="tiny" fill="#2C3E50" font-weight="bold">Load->S0</text>
    <rect x="260" y="20" width="100" height="35" fill="#27AE60" opacity="0.4" stroke="#27AE60" stroke-width="1.5" rx="3"/>
    <text x="310" y="42" text-anchor="middle" class="tiny" fill="#2C3E50" font-weight="bold">Load->S1</text>
    <rect x="370" y="20" width="100" height="35" fill="#E67E22" opacity="0.4" stroke="#E67E22" stroke-width="1.5" rx="3"/>
    <text x="420" y="42" text-anchor="middle" class="tiny" fill="#2C3E50" font-weight="bold">Load->S2</text>

    <!-- Main loop TMA loads (offset by WGMMA latency) -->
    <rect x="610" y="20" width="100" height="35" fill="#3498DB" opacity="0.4" stroke="#3498DB" stroke-width="1.5" rx="3"/>
    <text x="660" y="42" text-anchor="middle" class="tiny" fill="#2C3E50" font-weight="bold">Load->S0</text>
    <rect x="820" y="20" width="100" height="35" fill="#27AE60" opacity="0.4" stroke="#27AE60" stroke-width="1.5" rx="3"/>
    <text x="870" y="42" text-anchor="middle" class="tiny" fill="#2C3E50" font-weight="bold">Load->S1</text>
    <rect x="1030" y="20" width="100" height="35" fill="#E67E22" opacity="0.4" stroke="#E67E22" stroke-width="1.5" rx="3"/>
    <text x="1080" y="42" text-anchor="middle" class="tiny" fill="#2C3E50" font-weight="bold">Load->S2</text>
    <text x="1150" y="42" class="small" fill="#888">...</text>

    <!-- Barrier arrows down from TMA loads -->
    <path d="M200,55 L200,75" stroke="#9B59B6" stroke-width="1" stroke-dasharray="3,2"/>
    <path d="M310,55 L310,75" stroke="#9B59B6" stroke-width="1" stroke-dasharray="3,2"/>
    <path d="M420,55 L420,75" stroke="#9B59B6" stroke-width="1" stroke-dasharray="3,2"/>
    <path d="M660,55 L660,75" stroke="#9B59B6" stroke-width="1" stroke-dasharray="3,2"/>
    <path d="M870,55 L870,75" stroke="#9B59B6" stroke-width="1" stroke-dasharray="3,2"/>
    <path d="M1080,55 L1080,75" stroke="#9B59B6" stroke-width="1" stroke-dasharray="3,2"/>

    <!-- Small barrier labels -->
    <text x="200" y="72" text-anchor="middle" class="tiny" fill="#9B59B6">tma_bar</text>
    <text x="310" y="72" text-anchor="middle" class="tiny" fill="#9B59B6">tma_bar</text>
    <text x="420" y="72" text-anchor="middle" class="tiny" fill="#9B59B6">tma_bar</text>

    <!-- All threads (WGMMA) row -->
    <text x="0" y="100" class="small bold" fill="#E67E22">All 256</text>
    <text x="0" y="112" class="small" fill="#E67E22">threads</text>
    <text x="0" y="124" class="small" fill="#E67E22">(WGMMA)</text>

    <!-- Prologue gap -->
    <rect x="150" y="85" width="330" height="40" fill="#ECF0F1" stroke="#CCC" stroke-width="1" rx="3" stroke-dasharray="4,3"/>
    <text x="315" y="110" text-anchor="middle" class="small" fill="#888">Waiting for prologue to fill 3 stages...</text>

    <!-- WGMMA compute blocks -->
    <rect x="500" y="85" width="200" height="40" fill="#3498DB" opacity="0.3" stroke="#3498DB" stroke-width="1.5" rx="3"/>
    <text x="600" y="100" text-anchor="middle" class="tiny" fill="#2C3E50" font-weight="bold">WGMMA Stage 0 (k=0)</text>
    <text x="600" y="116" text-anchor="middle" class="tiny" fill="#2C3E50">128x128x32 FMAs</text>

    <rect x="710" y="85" width="200" height="40" fill="#27AE60" opacity="0.3" stroke="#27AE60" stroke-width="1.5" rx="3"/>
    <text x="810" y="100" text-anchor="middle" class="tiny" fill="#2C3E50" font-weight="bold">WGMMA Stage 1 (k=1)</text>
    <text x="810" y="116" text-anchor="middle" class="tiny" fill="#2C3E50">128x128x32 FMAs</text>

    <rect x="920" y="85" width="200" height="40" fill="#E67E22" opacity="0.3" stroke="#E67E22" stroke-width="1.5" rx="3"/>
    <text x="1020" y="100" text-anchor="middle" class="tiny" fill="#2C3E50" font-weight="bold">WGMMA Stage 2 (k=2)</text>
    <text x="1020" y="116" text-anchor="middle" class="tiny" fill="#2C3E50">128x128x32 FMAs</text>

    <text x="1140" y="110" class="small" fill="#888">...</text>

    <!-- Signal arrows up from WGMMA -->
    <path d="M700,85 L700,62" stroke="#E74C3C" stroke-width="1" stroke-dasharray="3,2" marker-end="url(#arrowhead-red)"/>
    <path d="M910,85 L910,62" stroke="#E74C3C" stroke-width="1" stroke-dasharray="3,2" marker-end="url(#arrowhead-red)"/>
    <path d="M1120,85 L1120,62" stroke="#E74C3C" stroke-width="1" stroke-dasharray="3,2" marker-end="url(#arrowhead-red)"/>

    <text x="700" y="80" text-anchor="middle" class="tiny" fill="#E74C3C">mma_bar</text>
    <text x="910" y="80" text-anchor="middle" class="tiny" fill="#E74C3C">mma_bar</text>
    <text x="1120" y="80" text-anchor="middle" class="tiny" fill="#E74C3C">mma_bar</text>

    <!-- Overlap annotation -->
    <g transform="translate(0, 145)">
      <rect x="500" y="0" width="200" height="30" fill="none" stroke="#333" stroke-width="1.5" stroke-dasharray="6,3" rx="3"/>
      <rect x="610" y="0" width="100" height="30" fill="none" stroke="#333" stroke-width="1.5" stroke-dasharray="6,3" rx="3"/>
      <text x="660" y="20" text-anchor="middle" class="tiny bold" fill="#333">OVERLAP</text>
      <path d="M500,-5 L500,35" stroke="#333" stroke-width="0.5" stroke-dasharray="2,2"/>
      <path d="M710,-5 L710,35" stroke="#333" stroke-width="0.5" stroke-dasharray="2,2"/>
    </g>

    <!-- Key insight boxes -->
    <g transform="translate(0, 192)">
      <rect x="0" y="0" width="400" height="28" fill="#D5F5E3" stroke="#27AE60" rx="4"/>
      <text x="200" y="18" text-anchor="middle" class="small" fill="#1E8449" font-weight="bold">TMA loads are single-thread, non-blocking</text>
      <rect x="420" y="0" width="400" height="28" fill="#FDEBD0" stroke="#E67E22" rx="4"/>
      <text x="620" y="18" text-anchor="middle" class="small" fill="#E67E22" font-weight="bold">WGMMA uses all 256 threads for compute</text>
      <rect x="840" y="0" width="420" height="28" fill="#E8D5F5" stroke="#9B59B6" rx="4"/>
      <text x="1050" y="18" text-anchor="middle" class="small" fill="#9B59B6" font-weight="bold">3 stages = 2 stages lookahead to hide latency</text>
    </g>
  </g>

  <!-- ============================================================ -->
  <!-- SECTION 6: Data Flow & Kernel Evolution                       -->
  <!-- ============================================================ -->
  <line x1="40" y1="1640" x2="1360" y2="1640" stroke="#DDD" stroke-width="1"/>
  <text x="50" y="1665" class="section-title">6. Data Flow &amp; Full Kernel Progression</text>

  <!-- Current kernel data flow -->
  <g transform="translate(60, 1690)">
    <!-- Stage 1: TMA (1 thread) -->
    <rect x="0" y="0" width="250" height="110" fill="#E8D5F5" stroke="#9B59B6" stroke-width="2" rx="8"/>
    <text x="125" y="22" text-anchor="middle" class="subtitle" fill="#9B59B6">TMA: Global -> SMEM</text>
    <text x="10" y="42" class="code">1 thread issues TMA instruction</text>
    <text x="10" y="58" class="code">HW: DRAM -> L2 -> swizzled SMEM</text>
    <text x="10" y="74" class="code">A: 128x32 = 4096 floats (16 KB)</text>
    <text x="10" y="90" class="code">B: 128x32 = 4096 floats (16 KB)</text>
    <text x="10" y="104" class="code" fill="#1E8449">No coalescing concerns!</text>

    <!-- Arrow -->
    <path d="M250,55 L300,55" class="arrow-bold"/>

    <!-- Stage 2: 3-Stage SMEM Pipeline -->
    <rect x="300" y="0" width="270" height="110" fill="#CADFF5" stroke="#4A90D9" stroke-width="2" rx="8"/>
    <text x="435" y="22" text-anchor="middle" class="subtitle" fill="#4A90D9">3-Stage Swizzled SMEM</text>
    <text x="310" y="42" class="code">3 copies of (A+B) tiles</text>
    <text x="310" y="58" class="code">SW128 swizzle pattern</text>
    <text x="310" y="74" class="code">Zero bank conflicts via swizzle</text>
    <text x="310" y="90" class="code">Total: 3x32KB = 96KB SMEM</text>
    <text x="310" y="104" class="code" fill="#1E8449">Pipeline hides latency</text>

    <!-- Arrow -->
    <path d="M570,55 L620,55" class="arrow-bold"/>

    <!-- Stage 3: WGMMA -->
    <rect x="620" y="0" width="260" height="110" fill="#FADBD8" stroke="#E74C3C" stroke-width="2" rx="8"/>
    <text x="750" y="22" text-anchor="middle" class="subtitle" fill="#E74C3C">WGMMA Compute</text>
    <text x="630" y="42" class="code">SMEM descriptors -> wgmma</text>
    <text x="630" y="58" class="code">2 warp groups, all 256 threads</text>
    <text x="630" y="74" class="code">128x128x32 = 524,288 FMAs/tile</text>
    <text x="630" y="90" class="code" fill="#E74C3C">C accumulator in registers</text>
    <text x="630" y="104" class="code bold" fill="#E74C3C">Peak tensor core throughput</text>

    <!-- Arrow down -->
    <path d="M750,110 L750,138" class="arrow-bold"/>

    <!-- Stage 4: Store -->
    <rect x="620" y="140" width="260" height="50" fill="#D5F5E3" stroke="#27AE60" stroke-width="2" rx="8"/>
    <text x="750" y="162" text-anchor="middle" class="subtitle" fill="#27AE60">Registers -> Global (Store C)</text>
    <text x="630" y="178" class="code" fill="#1E8449">copy(tCrC, tCgC) -- coalesced</text>

    <!-- Loop arrow -->
    <path d="M125,110 L125,150 L750,150 L750,138" fill="none" stroke="#888" stroke-width="1.5" stroke-dasharray="6,3"/>
    <text x="400" y="147" text-anchor="middle" class="small" fill="#888">repeat for each k-tile (K/32 iterations), pipelined across 3 stages</text>
  </g>

  <!-- Kernel Evolution Table -->
  <g transform="translate(60, 1910)">
    <text x="0" y="0" class="subtitle">Kernel Evolution: From Naive to SM90 TMA+WGMMA</text>

    <g transform="translate(0, 18)">
      <!-- Table background -->
      <rect x="0" y="0" width="1260" height="360" fill="white" stroke="#DDD" stroke-width="1" rx="6"/>

      <!-- Header -->
      <rect x="0" y="0" width="1260" height="24" fill="#ECF0F1" stroke="#DDD" stroke-width="1" rx="6"/>
      <text x="55" y="17" text-anchor="middle" class="small bold" fill="#333">Kernel</text>
      <text x="350" y="17" text-anchor="middle" class="small bold" fill="#333">Data Flow</text>
      <text x="750" y="17" text-anchor="middle" class="small bold" fill="#333">Key Feature</text>

      <!-- Rows -->
      <text x="10" y="41" class="code">01 naive</text>
      <text x="120" y="41" class="code" fill="#555">Global -> Reg -> scalar FMA -> Global</text>
      <text x="600" y="41" class="code" fill="#888">Baseline: no tiling, no smem</text>

      <text x="10" y="59" class="code">02 tiled</text>
      <text x="120" y="59" class="code" fill="#555">Global -> SMEM -> Reg -> scalar FMA -> Global</text>
      <text x="600" y="59" class="code" fill="#888">Block tiling, shared memory reuse</text>

      <text x="10" y="77" class="code">03 reg_tile</text>
      <text x="120" y="77" class="code" fill="#555">Global -> SMEM -> Reg(outer prod) -> scalar FMA -> Global</text>
      <text x="600" y="77" class="code" fill="#888">Register tiling, 4:1 compute:load</text>

      <text x="10" y="95" class="code">04 vec</text>
      <text x="120" y="95" class="code" fill="#555">Global(float4) -> padded SMEM -> Reg -> FMA -> Global</text>
      <text x="600" y="95" class="code" fill="#888">Vectorized loads (float4)</text>

      <text x="10" y="113" class="code">05 pipe</text>
      <text x="120" y="113" class="code" fill="#555">Global(float4) -> 2xSMEM(overlap) -> Reg -> FMA -> Global</text>
      <text x="600" y="113" class="code" fill="#888">Double-buffered smem pipeline</text>

      <text x="10" y="131" class="code">06 cute</text>
      <text x="120" y="131" class="code" fill="#555">Global -> Reg -> mma.sync -> Global</text>
      <text x="600" y="131" class="code" fill="#888">CuTe + tensor core mma.sync</text>

      <text x="10" y="149" class="code">07 smem</text>
      <text x="120" y="149" class="code" fill="#555">Global(cp_async) -> padded SMEM -> Reg -> mma.sync -> Global</text>
      <text x="600" y="149" class="code" fill="#888">cp_async global->smem, padded smem</text>

      <text x="10" y="167" class="code">08 persist</text>
      <text x="120" y="167" class="code" fill="#555">+ column-major persistent scheduling</text>
      <text x="600" y="167" class="code" fill="#888">Persistent kernel, reduced tail effect</text>

      <text x="10" y="185" class="code">09 swizzle</text>
      <text x="120" y="185" class="code" fill="#555">+ CTA swizzle for L2 reuse</text>
      <text x="600" y="185" class="code" fill="#888">CTA swizzle improves L2 hit rate</text>

      <text x="10" y="203" class="code">10 pipe</text>
      <text x="120" y="203" class="code" fill="#555">+ double-buffered cp_async pipeline</text>
      <text x="600" y="203" class="code" fill="#888">Overlapped cp_async + mma.sync</text>

      <text x="10" y="221" class="code">11 wgmma</text>
      <text x="120" y="221" class="code" fill="#555">cp_async -> swizzled SMEM -> wgmma(smem desc) -> Global</text>
      <text x="600" y="221" class="code" fill="#888">SM90 wgmma, swizzled smem, no reg frag</text>

      <text x="10" y="239" class="code">12 wg_pipe</text>
      <text x="120" y="239" class="code" fill="#555">+ double-buffered wgmma pipeline + CTA swizzle</text>
      <text x="600" y="239" class="code" fill="#888">Pipelined wgmma + L2 swizzle</text>

      <!-- Highlight row for kernel 13 -->
      <rect x="2" y="248" width="1256" height="22" fill="#E8D5F5" stroke="#9B59B6" stroke-width="1.5" rx="3"/>
      <text x="10" y="264" class="code bold" fill="#9B59B6">13 tma</text>
      <text x="120" y="264" class="code bold" fill="#9B59B6">TMA(1 thread) -> 3-stage swizzled SMEM -> wgmma -> Global</text>
      <text x="600" y="264" class="code bold" fill="#9B59B6">TMA HW loads, 3-stage pipeline, HW barriers</text>

      <!-- Evolution arrow -->
      <line x1="65" y1="34" x2="65" y2="268" stroke="#9B59B6" stroke-width="1.5" stroke-dasharray="4,3"/>
      <path d="M65,268 L65,250" stroke="#9B59B6" stroke-width="0" marker-end="url(#arrowhead-purple)"/>
    </g>

    <!-- Key benefits box -->
    <g transform="translate(0, 400)">
      <rect x="0" y="0" width="1260" height="120" fill="white" stroke="#9B59B6" stroke-width="2" rx="6"/>
      <text x="630" y="22" text-anchor="middle" class="subtitle" fill="#9B59B6">Key Benefits of TMA + WGMMA + 3-Stage Pipeline (Kernel 13)</text>
      <line x1="10" y1="30" x2="1250" y2="30" stroke="#EEE"/>

      <g transform="translate(20, 42)">
        <!-- Load -->
        <rect x="0" y="0" width="280" height="60" fill="#E8D5F5" stroke="#9B59B6" stroke-width="1" rx="4"/>
        <text x="140" y="18" text-anchor="middle" class="small bold" fill="#9B59B6">Load: Hardware TMA</text>
        <text x="10" y="34" class="code" fill="#555">1 thread, HW-managed</text>
        <text x="10" y="48" class="code" fill="#555">No coalescing / divergence</text>

        <!-- Compute -->
        <rect x="300" y="0" width="280" height="60" fill="#FDEBD0" stroke="#E67E22" stroke-width="1" rx="4"/>
        <text x="440" y="18" text-anchor="middle" class="small bold" fill="#E67E22">Compute: All 256 threads</text>
        <text x="310" y="34" class="code" fill="#555">WGMMA tensor cores</text>
        <text x="310" y="48" class="code" fill="#555">No threads wasted on loads</text>

        <!-- Pipeline -->
        <rect x="600" y="0" width="280" height="60" fill="#D5F5E3" stroke="#27AE60" stroke-width="1" rx="4"/>
        <text x="740" y="18" text-anchor="middle" class="small bold" fill="#27AE60">Pipeline: 3 stages</text>
        <text x="610" y="34" class="code" fill="#555">Hides TMA+DRAM latency</text>
        <text x="610" y="48" class="code" fill="#555">Near-perfect overlap</text>

        <!-- Sync -->
        <rect x="900" y="0" width="330" height="60" fill="#FADBD8" stroke="#E74C3C" stroke-width="1" rx="4"/>
        <text x="1065" y="18" text-anchor="middle" class="small bold" fill="#E74C3C">Sync: Hardware barriers</text>
        <text x="910" y="34" class="code" fill="#555">Not __syncthreads(), minimal</text>
        <text x="910" y="48" class="code" fill="#555">overhead, per-stage granularity</text>
      </g>

      <text x="630" y="112" text-anchor="middle" class="small bold" fill="#555">This is essentially what CUTLASS 3.0 generates under the hood.</text>
    </g>
  </g>

  <!-- Footer -->
  <text x="700" y="2775" text-anchor="middle" class="tiny" fill="#AAA">matmul_cute_wgmma_tma -- SM90 TMA + WGMMA + 3-Stage Pipeline Memory Access Pattern Diagram</text>
</svg>
