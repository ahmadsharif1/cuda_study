<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1400 2000" font-family="'Courier New', monospace">
  <style>
    .title { font-size: 22px; font-weight: bold; fill: #222; }
    .section-title { font-size: 17px; font-weight: bold; fill: #333; }
    .subtitle { font-size: 13px; font-weight: bold; fill: #555; }
    .label { font-size: 11px; fill: #333; }
    .small { font-size: 10px; fill: #555; }
    .tiny { font-size: 9px; fill: #666; }
    .code { font-size: 10px; fill: #333; font-family: monospace; }
    .bold { font-weight: bold; }
    .a-fill { fill: #4A90D9; }
    .a-light { fill: #CADFF5; }
    .b-fill { fill: #27AE60; }
    .b-light { fill: #B8E6CC; }
    .c-fill { fill: #E67E22; }
    .c-light { fill: #FDEBD0; }
    .warp-fill { fill: #F1C40F; opacity: 0.6; }
    .coalesced { fill: #8E44AD; }
    .coalesced-light { fill: #D7BDE2; }
    .strided { fill: #C0392B; }
    .reg-fill { fill: #ECF0F1; }
    .outline { fill: none; stroke: #333; stroke-width: 1; }
    .outline-bold { fill: none; stroke: #333; stroke-width: 2; }
    .arrow { fill: none; stroke: #555; stroke-width: 1.5; marker-end: url(#arrowhead); }
    .arrow-bold { fill: none; stroke: #333; stroke-width: 2; marker-end: url(#arrowhead); }
    .dashed { stroke-dasharray: 4,3; }
    .thread-grid { fill: #F9F9F9; stroke: #CCC; stroke-width: 0.5; }
    .broadcast { fill: #2ECC71; opacity: 0.3; }
    .bank-conflict { fill: #E74C3C; opacity: 0.3; }
    .dim-label { font-size: 11px; fill: #888; font-style: italic; }
  </style>
  <defs>
    <marker id="arrowhead" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto">
      <path d="M0,0 L8,3 L0,6 Z" fill="#555"/>
    </marker>
    <marker id="arrowhead-red" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto">
      <path d="M0,0 L8,3 L0,6 Z" fill="#C0392B"/>
    </marker>
    <marker id="arrowhead-green" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto">
      <path d="M0,0 L8,3 L0,6 Z" fill="#27AE60"/>
    </marker>
    <linearGradient id="fma-grad" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#F39C12;stop-opacity:0.8"/>
      <stop offset="100%" style="stop-color:#E74C3C;stop-opacity:0.8"/>
    </linearGradient>
  </defs>

  <!-- Background -->
  <rect width="1400" height="2000" fill="#FAFAFA" rx="8"/>

  <!-- Title -->
  <text x="700" y="35" text-anchor="middle" class="title">CuTe SMEM + CTA Swizzle: Memory Access Patterns</text>
  <text x="700" y="55" text-anchor="middle" class="small">BLK_M=128, BLK_N=128, BLK_K=32, SWIZZLE=4, SM80_16x8x8_F32TF32TF32F32_TN tiled _2x_2x_1, 128 threads, 1D grid</text>

  <!-- ============================================================ -->
  <!-- SECTION 1: CTA Swizzle Tile Scheduling                       -->
  <!-- ============================================================ -->
  <line x1="40" y1="70" x2="1360" y2="70" stroke="#DDD" stroke-width="1"/>
  <text x="50" y="95" class="section-title">1. CTA Swizzle Tile Scheduling (1D Grid to 2D Tile Mapping)</text>

  <!-- Swizzle formula box -->
  <g transform="translate(60, 115)">
    <rect width="500" height="110" fill="#EBF5FB" stroke="#4A90D9" stroke-width="1.5" rx="6"/>
    <text x="250" y="20" text-anchor="middle" class="subtitle" fill="#4A90D9">Swizzle Formula (from blockIdx.x)</text>
    <text x="15" y="40" class="code">num_m_tiles  = M / BLK_M</text>
    <text x="15" y="55" class="code">group_id     = blockIdx.x / (num_m_tiles * SWIZZLE)</text>
    <text x="15" y="70" class="code">first_n      = group_id * SWIZZLE</text>
    <text x="15" y="85" class="code">idx_in_group = blockIdx.x - group_id * (num_m_tiles * SWIZZLE)</text>
    <text x="15" y="100" class="code bold" fill="#C0392B">tile_m = idx_in_group % num_m_tiles     tile_n = first_n + idx_in_group / num_m_tiles</text>
  </g>

  <!-- Tile grid: 8 M-tiles x 8 N-tiles -->
  <g transform="translate(60, 245)">
    <text x="460" y="0" text-anchor="middle" class="subtitle">Tile Grid (8x8 example: M/128=8 rows, N/128=8 cols)</text>

    <!-- Column headers (N tiles) -->
    <text x="125" y="22" text-anchor="middle" class="small bold" fill="#27AE60">n=0</text>
    <text x="195" y="22" text-anchor="middle" class="small bold" fill="#27AE60">n=1</text>
    <text x="265" y="22" text-anchor="middle" class="small bold" fill="#27AE60">n=2</text>
    <text x="335" y="22" text-anchor="middle" class="small bold" fill="#27AE60">n=3</text>
    <text x="405" y="22" text-anchor="middle" class="small bold" fill="#8E44AD">n=4</text>
    <text x="475" y="22" text-anchor="middle" class="small bold" fill="#8E44AD">n=5</text>
    <text x="545" y="22" text-anchor="middle" class="small bold" fill="#8E44AD">n=6</text>
    <text x="615" y="22" text-anchor="middle" class="small bold" fill="#8E44AD">n=7</text>

    <!-- Row headers (M tiles) -->
    <text x="80" y="48" text-anchor="end" class="small bold" fill="#4A90D9">m=0</text>
    <text x="80" y="73" text-anchor="end" class="small bold" fill="#4A90D9">m=1</text>
    <text x="80" y="98" text-anchor="end" class="small bold" fill="#4A90D9">m=2</text>
    <text x="80" y="123" text-anchor="end" class="small bold" fill="#4A90D9">m=3</text>
    <text x="80" y="148" text-anchor="end" class="small bold" fill="#4A90D9">m=4</text>
    <text x="80" y="173" text-anchor="end" class="small bold" fill="#4A90D9">m=5</text>
    <text x="80" y="198" text-anchor="end" class="small bold" fill="#4A90D9">m=6</text>
    <text x="80" y="223" text-anchor="end" class="small bold" fill="#4A90D9">m=7</text>

    <!-- Group 0 (n=0..3): light blue background -->
    <rect x="90" y="30" width="280" height="200" fill="#4A90D9" opacity="0.08" stroke="#4A90D9" stroke-width="1.5" rx="4"/>

    <!-- Group 1 (n=4..7): light purple background -->
    <rect x="370" y="30" width="280" height="200" fill="#8E44AD" opacity="0.08" stroke="#8E44AD" stroke-width="1.5" rx="4"/>

    <!-- Grid cells - Group 0, n=0 (blocks 0-7) -->
    <rect x="90" y="35" width="70" height="22" fill="#3498DB" opacity="0.5" stroke="#2C3E50" stroke-width="0.8" rx="2"/>
    <text x="125" y="50" text-anchor="middle" class="tiny" fill="#333" font-weight="bold">B0</text>
    <rect x="90" y="60" width="70" height="22" fill="#3498DB" opacity="0.5" stroke="#2C3E50" stroke-width="0.8" rx="2"/>
    <text x="125" y="75" text-anchor="middle" class="tiny" fill="#333" font-weight="bold">B1</text>
    <rect x="90" y="85" width="70" height="22" fill="#3498DB" opacity="0.5" stroke="#2C3E50" stroke-width="0.8" rx="2"/>
    <text x="125" y="100" text-anchor="middle" class="tiny" fill="#333" font-weight="bold">B2</text>
    <rect x="90" y="110" width="70" height="22" fill="#3498DB" opacity="0.5" stroke="#2C3E50" stroke-width="0.8" rx="2"/>
    <text x="125" y="125" text-anchor="middle" class="tiny" fill="#333" font-weight="bold">B3</text>
    <rect x="90" y="135" width="70" height="22" fill="#3498DB" opacity="0.5" stroke="#2C3E50" stroke-width="0.8" rx="2"/>
    <text x="125" y="150" text-anchor="middle" class="tiny" fill="#333" font-weight="bold">B4</text>
    <rect x="90" y="160" width="70" height="22" fill="#3498DB" opacity="0.5" stroke="#2C3E50" stroke-width="0.8" rx="2"/>
    <text x="125" y="175" text-anchor="middle" class="tiny" fill="#333" font-weight="bold">B5</text>
    <rect x="90" y="185" width="70" height="22" fill="#3498DB" opacity="0.5" stroke="#2C3E50" stroke-width="0.8" rx="2"/>
    <text x="125" y="200" text-anchor="middle" class="tiny" fill="#333" font-weight="bold">B6</text>
    <rect x="90" y="210" width="70" height="22" fill="#3498DB" opacity="0.4" stroke="#2C3E50" stroke-width="0.8" rx="2"/>
    <text x="125" y="225" text-anchor="middle" class="tiny" fill="#333" font-weight="bold">B7</text>

    <!-- Group 0, n=1 (blocks 8-15) -->
    <rect x="160" y="35" width="70" height="22" fill="#27AE60" opacity="0.4" stroke="#2C3E50" stroke-width="0.8" rx="2"/>
    <text x="195" y="50" text-anchor="middle" class="tiny" fill="#333" font-weight="bold">B8</text>
    <rect x="160" y="60" width="70" height="22" fill="#27AE60" opacity="0.4" stroke="#2C3E50" stroke-width="0.8" rx="2"/>
    <text x="195" y="75" text-anchor="middle" class="tiny" fill="#333" font-weight="bold">B9</text>
    <rect x="160" y="85" width="70" height="22" fill="#27AE60" opacity="0.4" stroke="#2C3E50" stroke-width="0.8" rx="2"/>
    <text x="195" y="100" text-anchor="middle" class="tiny" fill="#333" font-weight="bold">B10</text>
    <rect x="160" y="110" width="70" height="22" fill="#27AE60" opacity="0.4" stroke="#2C3E50" stroke-width="0.8" rx="2"/>
    <text x="195" y="125" text-anchor="middle" class="tiny" fill="#333" font-weight="bold">B11</text>
    <rect x="160" y="135" width="70" height="22" fill="#27AE60" opacity="0.4" stroke="#2C3E50" stroke-width="0.8" rx="2"/>
    <text x="195" y="150" text-anchor="middle" class="tiny" fill="#333" font-weight="bold">B12</text>
    <rect x="160" y="160" width="70" height="22" fill="#27AE60" opacity="0.4" stroke="#2C3E50" stroke-width="0.8" rx="2"/>
    <text x="195" y="175" text-anchor="middle" class="tiny" fill="#333" font-weight="bold">B13</text>
    <rect x="160" y="185" width="70" height="22" fill="#27AE60" opacity="0.4" stroke="#2C3E50" stroke-width="0.8" rx="2"/>
    <text x="195" y="200" text-anchor="middle" class="tiny" fill="#333" font-weight="bold">B14</text>
    <rect x="160" y="210" width="70" height="22" fill="#27AE60" opacity="0.4" stroke="#2C3E50" stroke-width="0.8" rx="2"/>
    <text x="195" y="225" text-anchor="middle" class="tiny" fill="#333" font-weight="bold">B15</text>

    <!-- Group 0, n=2 (blocks 16-23) -->
    <rect x="230" y="35" width="70" height="22" fill="#E67E22" opacity="0.4" stroke="#2C3E50" stroke-width="0.8" rx="2"/>
    <text x="265" y="50" text-anchor="middle" class="tiny" fill="#333" font-weight="bold">B16</text>
    <rect x="230" y="60" width="70" height="22" fill="#E67E22" opacity="0.4" stroke="#2C3E50" stroke-width="0.8" rx="2"/>
    <text x="265" y="75" text-anchor="middle" class="tiny" fill="#333" font-weight="bold">B17</text>
    <rect x="230" y="85" width="70" height="22" fill="#E67E22" opacity="0.4" stroke="#2C3E50" stroke-width="0.8" rx="2"/>
    <text x="265" y="100" text-anchor="middle" class="tiny" fill="#333" font-weight="bold">B18</text>
    <rect x="230" y="110" width="70" height="22" fill="#E67E22" opacity="0.4" stroke="#2C3E50" stroke-width="0.8" rx="2"/>
    <text x="265" y="125" text-anchor="middle" class="tiny" fill="#333" font-weight="bold">B19</text>
    <rect x="230" y="135" width="70" height="22" fill="#E67E22" opacity="0.4" stroke="#2C3E50" stroke-width="0.8" rx="2"/>
    <text x="265" y="150" text-anchor="middle" class="tiny" fill="#333" font-weight="bold">B20</text>
    <rect x="230" y="160" width="70" height="22" fill="#E67E22" opacity="0.4" stroke="#2C3E50" stroke-width="0.8" rx="2"/>
    <text x="265" y="175" text-anchor="middle" class="tiny" fill="#333" font-weight="bold">B21</text>
    <rect x="230" y="185" width="70" height="22" fill="#E67E22" opacity="0.4" stroke="#2C3E50" stroke-width="0.8" rx="2"/>
    <text x="265" y="200" text-anchor="middle" class="tiny" fill="#333" font-weight="bold">B22</text>
    <rect x="230" y="210" width="70" height="22" fill="#E67E22" opacity="0.4" stroke="#2C3E50" stroke-width="0.8" rx="2"/>
    <text x="265" y="225" text-anchor="middle" class="tiny" fill="#333" font-weight="bold">B23</text>

    <!-- Group 0, n=3 (blocks 24-31) -->
    <rect x="300" y="35" width="70" height="22" fill="#C0392B" opacity="0.35" stroke="#2C3E50" stroke-width="0.8" rx="2"/>
    <text x="335" y="50" text-anchor="middle" class="tiny" fill="#333" font-weight="bold">B24</text>
    <rect x="300" y="60" width="70" height="22" fill="#C0392B" opacity="0.35" stroke="#2C3E50" stroke-width="0.8" rx="2"/>
    <text x="335" y="75" text-anchor="middle" class="tiny" fill="#333" font-weight="bold">B25</text>
    <rect x="300" y="85" width="70" height="22" fill="#C0392B" opacity="0.35" stroke="#2C3E50" stroke-width="0.8" rx="2"/>
    <text x="335" y="100" text-anchor="middle" class="tiny" fill="#333" font-weight="bold">B26</text>
    <rect x="300" y="110" width="70" height="22" fill="#C0392B" opacity="0.35" stroke="#2C3E50" stroke-width="0.8" rx="2"/>
    <text x="335" y="125" text-anchor="middle" class="tiny" fill="#333" font-weight="bold">B27</text>
    <rect x="300" y="135" width="70" height="22" fill="#C0392B" opacity="0.35" stroke="#2C3E50" stroke-width="0.8" rx="2"/>
    <text x="335" y="150" text-anchor="middle" class="tiny" fill="#333" font-weight="bold">B28</text>
    <rect x="300" y="160" width="70" height="22" fill="#C0392B" opacity="0.35" stroke="#2C3E50" stroke-width="0.8" rx="2"/>
    <text x="335" y="175" text-anchor="middle" class="tiny" fill="#333" font-weight="bold">B29</text>
    <rect x="300" y="185" width="70" height="22" fill="#C0392B" opacity="0.35" stroke="#2C3E50" stroke-width="0.8" rx="2"/>
    <text x="335" y="200" text-anchor="middle" class="tiny" fill="#333" font-weight="bold">B30</text>
    <rect x="300" y="210" width="70" height="22" fill="#C0392B" opacity="0.35" stroke="#2C3E50" stroke-width="0.8" rx="2"/>
    <text x="335" y="225" text-anchor="middle" class="tiny" fill="#333" font-weight="bold">B31</text>

    <!-- Group 1: fill n=4..7 similarly with lighter shading -->
    <rect x="370" y="35" width="70" height="197" fill="#9B59B6" opacity="0.15" stroke="none" rx="2"/>
    <text x="405" y="130" text-anchor="middle" class="tiny" fill="#8E44AD">B32-39</text>
    <rect x="440" y="35" width="70" height="197" fill="#9B59B6" opacity="0.15" stroke="none" rx="2"/>
    <text x="475" y="130" text-anchor="middle" class="tiny" fill="#8E44AD">B40-47</text>
    <rect x="510" y="35" width="70" height="197" fill="#9B59B6" opacity="0.15" stroke="none" rx="2"/>
    <text x="545" y="130" text-anchor="middle" class="tiny" fill="#8E44AD">B48-55</text>
    <rect x="580" y="35" width="70" height="197" fill="#9B59B6" opacity="0.15" stroke="none" rx="2"/>
    <text x="615" y="130" text-anchor="middle" class="tiny" fill="#8E44AD">B56-63</text>

    <!-- Group labels -->
    <text x="230" y="248" text-anchor="middle" class="small bold" fill="#4A90D9">Group 0: blocks 0-31</text>
    <text x="510" y="248" text-anchor="middle" class="small bold" fill="#8E44AD">Group 1: blocks 32-63</text>

    <!-- Key insight annotation -->
    <g transform="translate(680, 35)">
      <rect width="600" height="200" fill="white" stroke="#333" stroke-width="1.5" rx="6"/>
      <text x="300" y="22" text-anchor="middle" class="subtitle">Key Insight: Column-Major Within Each Group</text>
      <line x1="10" y1="30" x2="590" y2="30" stroke="#EEE"/>
      <text x="15" y="48" class="code">Within Group 0 (blocks 0..31):</text>
      <text x="15" y="65" class="code" fill="#3498DB">  n=0: B0, B1, B2, B3, B4, B5, B6, B7  (all M-rows)</text>
      <text x="15" y="80" class="code" fill="#27AE60">  n=1: B8, B9, B10,B11,B12,B13,B14,B15</text>
      <text x="15" y="95" class="code" fill="#E67E22">  n=2: B16,B17,B18,B19,B20,B21,B22,B23</text>
      <text x="15" y="110" class="code" fill="#C0392B">  n=3: B24,B25,B26,B27,B28,B29,B30,B31</text>
      <line x1="15" y1="118" x2="585" y2="118" stroke="#EEE"/>
      <text x="15" y="136" class="code bold">M varies first (column-major) within each N-column.</text>
      <text x="15" y="153" class="code">Adjacent blockIdx.x values (e.g. B0..B7) share same</text>
      <text x="15" y="168" class="code">N-column tile_n=0 and are co-scheduled on nearby SMs</text>
      <text x="15" y="185" class="code" fill="#1E8449">--> They all load the SAME B[:,0:128] column --> L2 reuse!</text>
    </g>
  </g>

  <!-- ============================================================ -->
  <!-- SECTION 2: L2 Cache Reuse Visualization                      -->
  <!-- ============================================================ -->
  <line x1="40" y1="530" x2="1360" y2="530" stroke="#DDD" stroke-width="1"/>
  <text x="50" y="555" class="section-title">2. L2 Cache Reuse: Why Swizzle Helps</text>

  <g transform="translate(60, 575)">
    <!-- Show data sharing for B -->
    <text x="0" y="0" class="subtitle" fill="#27AE60">B Matrix Data Sharing (n=0 column, Group 0)</text>

    <!-- Draw B column strip -->
    <g transform="translate(0, 20)">
      <rect x="0" y="0" width="80" height="170" fill="#B8E6CC" stroke="#27AE60" stroke-width="2" rx="3"/>
      <text x="40" y="18" text-anchor="middle" class="small bold" fill="#1E8449">B[:, 0:128]</text>
      <text x="40" y="35" text-anchor="middle" class="tiny" fill="#333">Full K-dim</text>
      <text x="40" y="50" text-anchor="middle" class="tiny" fill="#333">column strip</text>
      <text x="40" y="85" text-anchor="middle" class="small bold" fill="#333">Shared by</text>
      <text x="40" y="100" text-anchor="middle" class="small bold" fill="#333">8 blocks</text>

      <!-- Arrows from B to blocks -->
      <line x1="80" y1="25" x2="120" y2="10" stroke="#27AE60" stroke-width="1.2" marker-end="url(#arrowhead-green)"/>
      <line x1="80" y1="45" x2="120" y2="35" stroke="#27AE60" stroke-width="1.2" marker-end="url(#arrowhead-green)"/>
      <line x1="80" y1="65" x2="120" y2="60" stroke="#27AE60" stroke-width="1.2" marker-end="url(#arrowhead-green)"/>
      <line x1="80" y1="85" x2="120" y2="85" stroke="#27AE60" stroke-width="1.2" marker-end="url(#arrowhead-green)"/>
      <line x1="80" y1="105" x2="120" y2="110" stroke="#27AE60" stroke-width="1.2" marker-end="url(#arrowhead-green)"/>
      <line x1="80" y1="120" x2="120" y2="130" stroke="#27AE60" stroke-width="1.2" marker-end="url(#arrowhead-green)"/>
      <line x1="80" y1="135" x2="120" y2="148" stroke="#27AE60" stroke-width="1.2" marker-end="url(#arrowhead-green)"/>
      <line x1="80" y1="148" x2="120" y2="165" stroke="#27AE60" stroke-width="1.2" marker-end="url(#arrowhead-green)"/>

      <!-- Block list -->
      <rect x="125" y="0" width="90" height="22" fill="#3498DB" opacity="0.5" stroke="#2C3E50" stroke-width="0.8" rx="2"/>
      <text x="170" y="15" text-anchor="middle" class="tiny" fill="#333" font-weight="bold">B0 (m=0,n=0)</text>
      <rect x="125" y="25" width="90" height="22" fill="#3498DB" opacity="0.5" stroke="#2C3E50" stroke-width="0.8" rx="2"/>
      <text x="170" y="40" text-anchor="middle" class="tiny" fill="#333" font-weight="bold">B1 (m=1,n=0)</text>
      <rect x="125" y="50" width="90" height="22" fill="#3498DB" opacity="0.5" stroke="#2C3E50" stroke-width="0.8" rx="2"/>
      <text x="170" y="65" text-anchor="middle" class="tiny" fill="#333" font-weight="bold">B2 (m=2,n=0)</text>
      <rect x="125" y="75" width="90" height="22" fill="#3498DB" opacity="0.45" stroke="#2C3E50" stroke-width="0.8" rx="2"/>
      <text x="170" y="90" text-anchor="middle" class="tiny" fill="#333" font-weight="bold">B3 (m=3,n=0)</text>
      <rect x="125" y="100" width="90" height="22" fill="#3498DB" opacity="0.4" stroke="#2C3E50" stroke-width="0.8" rx="2"/>
      <text x="170" y="115" text-anchor="middle" class="tiny" fill="#333" font-weight="bold">B4 (m=4,n=0)</text>
      <rect x="125" y="122" width="90" height="22" fill="#3498DB" opacity="0.35" stroke="#2C3E50" stroke-width="0.8" rx="2"/>
      <text x="170" y="137" text-anchor="middle" class="tiny" fill="#333" font-weight="bold">B5 (m=5,n=0)</text>
      <rect x="125" y="144" width="90" height="22" fill="#3498DB" opacity="0.3" stroke="#2C3E50" stroke-width="0.8" rx="2"/>
      <text x="170" y="159" text-anchor="middle" class="tiny" fill="#333" font-weight="bold">B6 (m=6,n=0)</text>
      <rect x="125" y="166" width="90" height="22" fill="#3498DB" opacity="0.25" stroke="#2C3E50" stroke-width="0.8" rx="2"/>
      <text x="170" y="181" text-anchor="middle" class="tiny" fill="#333" font-weight="bold">B7 (m=7,n=0)</text>
    </g>

    <!-- Similarly for A rows -->
    <g transform="translate(280, 20)">
      <text x="110" y="-18" text-anchor="middle" class="subtitle" fill="#4A90D9">A Matrix Data Sharing (m=0 row, Group 0)</text>
      <rect x="0" y="0" width="220" height="40" fill="#CADFF5" stroke="#4A90D9" stroke-width="2" rx="3"/>
      <text x="110" y="18" text-anchor="middle" class="small bold" fill="#2C3E50">A[0:128, :] (full K-dim row strip)</text>
      <text x="110" y="32" text-anchor="middle" class="tiny" fill="#333">Shared by blocks with same tile_m across N-cols</text>

      <text x="0" y="60" class="code">Blocks B0(m=0,n=0), B8(m=0,n=1), B16(m=0,n=2), B24(m=0,n=3)</text>
      <text x="0" y="75" class="code">all load A[0:128, k:k+32] for each k-tile</text>
      <text x="0" y="92" class="code" fill="#1E8449">These 4 blocks are in the same group -> A data stays in L2</text>
    </g>

    <!-- L2 cache box -->
    <g transform="translate(280, 140)">
      <rect width="510" height="60" fill="#D5F5E3" stroke="#27AE60" stroke-width="1.5" rx="6"/>
      <text x="255" y="20" text-anchor="middle" class="subtitle" fill="#1E8449">L2 Cache Benefit</text>
      <text x="15" y="38" class="code" fill="#1E8449">B column data: loaded by B0 on SM_x, still in L2 when B1 on SM_y reads it</text>
      <text x="15" y="52" class="code" fill="#1E8449">A row data: loaded by B0 at (m=0,n=0), reused by B8 at (m=0,n=1)</text>
    </g>

    <!-- A/B data size note -->
    <g transform="translate(800, 18)">
      <rect width="460" height="185" fill="white" stroke="#DDD" stroke-width="1" rx="6"/>
      <text x="230" y="20" text-anchor="middle" class="subtitle">Data Volume Per K-Tile Iteration</text>
      <line x1="10" y1="28" x2="450" y2="28" stroke="#EEE"/>
      <text x="15" y="46" class="code" fill="#4A90D9">A tile: 128 x 32 = 4096 floats = 16 KB</text>
      <text x="15" y="62" class="code" fill="#27AE60">B tile: 128 x 32 = 4096 floats = 16 KB</text>
      <line x1="15" y1="72" x2="440" y2="72" stroke="#EEE"/>
      <text x="15" y="90" class="code">With SWIZZLE=4, group has 8*4 = 32 blocks</text>
      <text x="15" y="106" class="code">B columns in L2 for group: 4 x 16KB = 64 KB</text>
      <text x="15" y="122" class="code">A rows in L2 for group:    8 x 16KB = 128 KB</text>
      <text x="15" y="140" class="code">Total L2 working set: ~192 KB per k-tile</text>
      <line x1="15" y1="148" x2="440" y2="148" stroke="#EEE"/>
      <text x="15" y="166" class="code bold" fill="#1E8449">L2 cache (e.g. 40MB on A100) easily holds this!</text>
      <text x="15" y="180" class="code">Without swizzle: co-scheduled blocks may need many more</text>
    </g>
  </g>

  <!-- ============================================================ -->
  <!-- SECTION 3: Comparison: 2D Grid vs 1D Swizzled                -->
  <!-- ============================================================ -->
  <line x1="40" y1="810" x2="1360" y2="810" stroke="#DDD" stroke-width="1"/>
  <text x="50" y="835" class="section-title">3. Comparison: 2D Grid vs 1D Swizzled Grid</text>

  <!-- 2D Grid (bad) -->
  <g transform="translate(60, 855)">
    <rect width="600" height="320" fill="white" stroke="#C0392B" stroke-width="2" rx="8"/>
    <text x="300" y="22" text-anchor="middle" class="subtitle" fill="#C0392B">2D Grid: grid(N/128, M/128) -- Poor L2 Reuse</text>
    <line x1="10" y1="30" x2="590" y2="30" stroke="#FADBD8"/>

    <text x="15" y="48" class="code">blockIdx = (x, y)</text>
    <text x="15" y="63" class="code">Scheduling order: (0,0),(1,0),(2,0),...,(7,0),(0,1),(1,1),...</text>
    <text x="15" y="80" class="code" fill="#C0392B">Co-resident blocks may be: (0,0),(1,0),(2,0),...,(7,0)</text>
    <text x="15" y="95" class="code" fill="#C0392B">--> same m=0, but n=0,1,2,...,7 (ALL different N columns!)</text>

    <!-- Mini grid showing bad pattern -->
    <g transform="translate(30, 110)">
      <text x="0" y="0" class="small bold">First 8 blocks scheduled (possible):</text>
      <!-- Show a 4x4 mini grid with the first blocks highlighted across row -->
      <text x="45" y="22" text-anchor="middle" class="tiny">n=0</text>
      <text x="95" y="22" text-anchor="middle" class="tiny">n=1</text>
      <text x="145" y="22" text-anchor="middle" class="tiny">n=2</text>
      <text x="195" y="22" text-anchor="middle" class="tiny">...</text>
      <text x="245" y="22" text-anchor="middle" class="tiny">n=7</text>

      <text x="10" y="42" text-anchor="end" class="tiny">m=0</text>
      <rect x="20" y="28" width="50" height="22" fill="#E74C3C" opacity="0.5" stroke="#333" stroke-width="1" rx="2"/>
      <text x="45" y="43" text-anchor="middle" class="tiny" fill="white" font-weight="bold">(0,0)</text>
      <rect x="70" y="28" width="50" height="22" fill="#E74C3C" opacity="0.5" stroke="#333" stroke-width="1" rx="2"/>
      <text x="95" y="43" text-anchor="middle" class="tiny" fill="white" font-weight="bold">(1,0)</text>
      <rect x="120" y="28" width="50" height="22" fill="#E74C3C" opacity="0.5" stroke="#333" stroke-width="1" rx="2"/>
      <text x="145" y="43" text-anchor="middle" class="tiny" fill="white" font-weight="bold">(2,0)</text>
      <text x="195" y="43" text-anchor="middle" class="tiny" fill="#C0392B">...</text>
      <rect x="220" y="28" width="50" height="22" fill="#E74C3C" opacity="0.5" stroke="#333" stroke-width="1" rx="2"/>
      <text x="245" y="43" text-anchor="middle" class="tiny" fill="white" font-weight="bold">(7,0)</text>
    </g>

    <g transform="translate(30, 185)">
      <rect width="540" height="50" fill="#FADBD8" stroke="#C0392B" rx="4"/>
      <text x="270" y="18" text-anchor="middle" class="small" fill="#C0392B" font-weight="bold">Each block needs a DIFFERENT B column in L2</text>
      <text x="270" y="35" text-anchor="middle" class="small" fill="#C0392B">8 distinct B[:,n:n+128] = 8 x 16KB = 128KB of B data competing for L2</text>
    </g>

    <text x="30" y="260" class="code" fill="#C0392B">Only 1 A row shared (A[0:128,:]), but 8 different B columns needed!</text>
    <text x="30" y="278" class="code" fill="#C0392B">L2 thrashing: B data evicted before reuse, high DRAM traffic</text>
  </g>

  <!-- 1D Swizzled Grid (good) -->
  <g transform="translate(700, 855)">
    <rect width="660" height="320" fill="white" stroke="#27AE60" stroke-width="2" rx="8"/>
    <text x="330" y="22" text-anchor="middle" class="subtitle" fill="#1E8449">1D Swizzled Grid: grid(total_tiles) -- Good L2 Reuse</text>
    <line x1="10" y1="30" x2="650" y2="30" stroke="#D5F5E3"/>

    <text x="15" y="48" class="code">blockIdx.x = 0,1,2,...,total_tiles-1</text>
    <text x="15" y="63" class="code">Swizzle maps: 0..7 -> (m=0..7, n=0), 8..15 -> (m=0..7, n=1), ...</text>
    <text x="15" y="80" class="code" fill="#1E8449">Co-resident blocks: B0..B7 all share n=0 (SAME B column!)</text>
    <text x="15" y="95" class="code" fill="#1E8449">--> 8 blocks x 1 B column = only 16KB of B data in L2</text>

    <!-- Mini grid showing good pattern -->
    <g transform="translate(30, 110)">
      <text x="0" y="0" class="small bold">First 8 blocks scheduled:</text>
      <text x="45" y="22" text-anchor="middle" class="tiny">n=0</text>

      <text x="10" y="42" text-anchor="end" class="tiny">m=0</text>
      <rect x="20" y="28" width="50" height="22" fill="#27AE60" opacity="0.5" stroke="#333" stroke-width="1" rx="2"/>
      <text x="45" y="43" text-anchor="middle" class="tiny" fill="white" font-weight="bold">B0</text>
      <text x="10" y="65" text-anchor="end" class="tiny">m=1</text>
      <rect x="20" y="52" width="50" height="22" fill="#27AE60" opacity="0.5" stroke="#333" stroke-width="1" rx="2"/>
      <text x="45" y="67" text-anchor="middle" class="tiny" fill="white" font-weight="bold">B1</text>
      <text x="10" y="88" text-anchor="end" class="tiny">m=2</text>
      <rect x="20" y="76" width="50" height="22" fill="#27AE60" opacity="0.5" stroke="#333" stroke-width="1" rx="2"/>
      <text x="45" y="91" text-anchor="middle" class="tiny" fill="white" font-weight="bold">B2</text>
      <text x="80" y="72" class="tiny" fill="#1E8449">... all same n=0!</text>
      <text x="10" y="115" text-anchor="end" class="tiny">...</text>
      <text x="10" y="138" text-anchor="end" class="tiny">m=7</text>
      <rect x="20" y="124" width="50" height="22" fill="#27AE60" opacity="0.45" stroke="#333" stroke-width="1" rx="2"/>
      <text x="45" y="139" text-anchor="middle" class="tiny" fill="white" font-weight="bold">B7</text>
    </g>

    <g transform="translate(30, 185)">
      <rect width="600" height="50" fill="#D5F5E3" stroke="#27AE60" rx="4"/>
      <text x="300" y="18" text-anchor="middle" class="small" fill="#1E8449" font-weight="bold">All 8 blocks share SAME B column in L2 cache</text>
      <text x="300" y="35" text-anchor="middle" class="small" fill="#1E8449">Only 1 x 16KB B data + 8 x 16KB A data = 144KB total L2 working set</text>
    </g>

    <text x="30" y="260" class="code" fill="#1E8449">B0 loads B[:,0:128], still in L2 when B1..B7 read same data</text>
    <text x="30" y="278" class="code" fill="#1E8449">Within group: 4 N-cols x 8 M-rows processed -> minimal L2 evictions</text>
  </g>

  <!-- ============================================================ -->
  <!-- SECTION 4: Per-Block Compute (identical to cute_smem)        -->
  <!-- ============================================================ -->
  <line x1="40" y1="1200" x2="1360" y2="1200" stroke="#DDD" stroke-width="1"/>
  <text x="50" y="1225" class="section-title">4. Per-Block Compute (Identical to CuTe SMEM)</text>

  <g transform="translate(60, 1245)">
    <!-- Pipeline stages inline -->
    <rect x="0" y="0" width="260" height="100" fill="#EBF5FB" stroke="#4A90D9" stroke-width="2" rx="8"/>
    <text x="130" y="20" text-anchor="middle" class="subtitle" fill="#4A90D9">Global -> Shared (cp_async)</text>
    <text x="10" y="40" class="code">cp_async 128-bit (uint128_t)</text>
    <text x="10" y="55" class="code">A: 128x32, padded stride BLK_K+4</text>
    <text x="10" y="70" class="code">B: 128x32, padded stride BLK_N+4</text>
    <text x="10" y="88" class="code" fill="#1E8449">Coalesced loads, pad avoids bank conflicts</text>

    <path d="M270,50 L310,50" class="arrow-bold"/>

    <rect x="320" y="0" width="260" height="100" fill="#FDEBD0" stroke="#E67E22" stroke-width="2" rx="8"/>
    <text x="450" y="20" text-anchor="middle" class="subtitle" fill="#E67E22">Shared -> Registers</text>
    <text x="330" y="40" class="code">thr_mma.partition_A(sA) -> tCrA</text>
    <text x="330" y="55" class="code">thr_mma.partition_B(sB) -> tCrB</text>
    <text x="330" y="70" class="code">SM80_16x8x8 MMA atoms</text>
    <text x="330" y="88" class="code">Tiled _2x_2x_1 (128 threads)</text>

    <path d="M590,50 L630,50" class="arrow-bold"/>

    <rect x="640" y="0" width="240" height="100" fill="#FADBD8" stroke="#E74C3C" stroke-width="2" rx="8"/>
    <text x="760" y="20" text-anchor="middle" class="subtitle" fill="#E74C3C">MMA Compute</text>
    <text x="650" y="40" class="code">gemm(tiled_mma, tCrA, tCrB, tCrC)</text>
    <text x="650" y="55" class="code">mma.sync.aligned.m16n8k8</text>
    <text x="650" y="70" class="code">TF32 inputs, FP32 accum</text>
    <text x="650" y="88" class="code" fill="#E74C3C">Tensor core operations</text>

    <path d="M890,50 L930,50" class="arrow-bold"/>

    <rect x="940" y="0" width="200" height="100" fill="#D5F5E3" stroke="#27AE60" stroke-width="2" rx="8"/>
    <text x="1040" y="20" text-anchor="middle" class="subtitle" fill="#27AE60">Store C</text>
    <text x="950" y="40" class="code">copy(tCrC, tCgC)</text>
    <text x="950" y="55" class="code">Registers -> Global</text>
    <text x="950" y="70" class="code">128x128 output tile</text>
    <text x="950" y="88" class="code" fill="#1E8449">Coalesced writes</text>

    <!-- Loop arrow -->
    <path d="M130,100 L130,130 L760,130 L760,100" fill="none" stroke="#888" stroke-width="1.5" stroke-dasharray="6,3"/>
    <text x="440" y="128" text-anchor="middle" class="small" fill="#888">repeat for each K-tile (K/32 iterations)</text>

    <!-- Note box -->
    <g transform="translate(0, 155)">
      <rect width="1140" height="42" fill="#FCF3CF" stroke="#F1C40F" stroke-width="1" rx="4"/>
      <text x="570" y="17" text-anchor="middle" class="small bold" fill="#7D6608">Per-block access patterns are identical to CuTe SMEM (see 07_cute_smem.svg for details)</text>
      <text x="570" y="33" text-anchor="middle" class="small" fill="#7D6608">The ONLY difference is tile scheduling: which (tile_m, tile_n) each block computes</text>
    </g>
  </g>

  <!-- ============================================================ -->
  <!-- SECTION 5: Data Flow Summary                                 -->
  <!-- ============================================================ -->
  <line x1="40" y1="1480" x2="1360" y2="1480" stroke="#DDD" stroke-width="1"/>
  <text x="50" y="1505" class="section-title">5. Data Flow Summary</text>

  <g transform="translate(60, 1525)">
    <!-- Full pipeline flow -->
    <!-- CTA Swizzle Scheduler -->
    <rect x="0" y="30" width="200" height="90" fill="#D7BDE2" stroke="#8E44AD" stroke-width="2" rx="8"/>
    <text x="100" y="52" text-anchor="middle" class="subtitle" fill="#8E44AD">CTA Swizzle</text>
    <text x="100" y="68" text-anchor="middle" class="subtitle" fill="#8E44AD">Scheduler</text>
    <text x="10" y="85" class="code">1D blockIdx.x</text>
    <text x="10" y="100" class="code">-> (tile_m, tile_n)</text>

    <path d="M210,75 L250,75" class="arrow-bold"/>

    <!-- Global -> Shared -->
    <rect x="260" y="30" width="200" height="90" fill="#EBF5FB" stroke="#4A90D9" stroke-width="2" rx="8"/>
    <text x="360" y="52" text-anchor="middle" class="subtitle" fill="#4A90D9">Global -> Shared</text>
    <text x="270" y="72" class="code">cp_async 128-bit</text>
    <text x="270" y="87" class="code">A[128x32] + B[128x32]</text>
    <text x="270" y="102" class="code">Padded smem layout</text>

    <path d="M470,75 L510,75" class="arrow-bold"/>

    <!-- Shared -> Registers -->
    <rect x="520" y="30" width="200" height="90" fill="#FDEBD0" stroke="#E67E22" stroke-width="2" rx="8"/>
    <text x="620" y="52" text-anchor="middle" class="subtitle" fill="#E67E22">Shared -> Reg</text>
    <text x="530" y="72" class="code">partition_A / _B</text>
    <text x="530" y="87" class="code">copy(tCsA, tCrA)</text>
    <text x="530" y="102" class="code">copy(tCsB, tCrB)</text>

    <path d="M730,75 L770,75" class="arrow-bold"/>

    <!-- MMA -->
    <rect x="780" y="30" width="180" height="90" fill="#FADBD8" stroke="#E74C3C" stroke-width="2" rx="8"/>
    <text x="870" y="52" text-anchor="middle" class="subtitle" fill="#E74C3C">MMA Compute</text>
    <text x="790" y="72" class="code">gemm(tiled_mma,</text>
    <text x="790" y="87" class="code">  tCrA, tCrB, tCrC)</text>
    <text x="790" y="102" class="code">mma.sync TF32</text>

    <path d="M970,75 L1010,75" class="arrow-bold"/>

    <!-- Store -->
    <rect x="1020" y="30" width="170" height="90" fill="#D5F5E3" stroke="#27AE60" stroke-width="2" rx="8"/>
    <text x="1105" y="52" text-anchor="middle" class="subtitle" fill="#27AE60">Store C</text>
    <text x="1030" y="72" class="code">copy(tCrC, tCgC)</text>
    <text x="1030" y="87" class="code">Registers -> Global</text>
    <text x="1030" y="102" class="code">Coalesced writes</text>

    <!-- Highlight the swizzle as the key addition -->
    <rect x="-5" y="22" width="212" height="106" fill="none" stroke="#8E44AD" stroke-width="3" stroke-dasharray="6,3" rx="10"/>
    <text x="100" y="14" text-anchor="middle" class="small bold" fill="#8E44AD">NEW: CTA Swizzle</text>

    <!-- Key insight box -->
    <g transform="translate(0, 150)">
      <rect width="1190" height="110" fill="white" stroke="#333" stroke-width="1.5" rx="6"/>
      <text x="595" y="22" text-anchor="middle" class="subtitle">Key Takeaways</text>
      <line x1="10" y1="30" x2="1180" y2="30" stroke="#EEE"/>
      <text x="15" y="48" class="code">1. Per-block compute pipeline is IDENTICAL to cute_smem: cp_async -> padded smem -> registers -> mma.sync</text>
      <text x="15" y="66" class="code" fill="#8E44AD">2. CTA swizzle changes tile SCHEDULING, not tile COMPUTATION: 1D grid with column-major groups of SWIZZLE N-cols</text>
      <text x="15" y="84" class="code" fill="#1E8449">3. Co-scheduled blocks share B column data in L2 cache -> fewer DRAM accesses for B matrix</text>
      <text x="15" y="102" class="code" fill="#1E8449">4. Within each group, same-m blocks share A row data in L2 -> amortized A loading cost</text>
    </g>

    <!-- Sync points -->
    <g transform="translate(0, 280)">
      <rect width="1190" height="45" fill="#FCF3CF" stroke="#F1C40F" stroke-width="1" rx="4"/>
      <text x="595" y="18" text-anchor="middle" class="small bold" fill="#7D6608">Synchronization: cp_async_fence() + cp_async_wait&lt;0&gt;() + __syncthreads() per k-tile</text>
      <text x="595" y="35" text-anchor="middle" class="small" fill="#7D6608">Same serialized load-then-compute pattern as cute_smem (no overlap -- see cute_pipe for pipelined version)</text>
    </g>
  </g>

  <!-- Footer -->
  <text x="700" y="1975" text-anchor="middle" class="tiny" fill="#AAA">matmul_cute_swizzle&lt;128, 128, 32, 4&gt; -- CTA Swizzle Tile Scheduling for L2 Cache Reuse</text>
</svg>
