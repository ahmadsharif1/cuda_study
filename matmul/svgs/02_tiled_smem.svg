<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1400 1400" font-family="'Courier New', monospace">
  <style>
    .title { font-size: 22px; font-weight: bold; fill: #222; }
    .section-title { font-size: 17px; font-weight: bold; fill: #333; }
    .subtitle { font-size: 13px; font-weight: bold; fill: #555; }
    .label { font-size: 11px; fill: #333; }
    .small { font-size: 10px; fill: #555; }
    .tiny { font-size: 9px; fill: #666; }
    .code { font-size: 10px; fill: #333; font-family: monospace; }
    .bold { font-weight: bold; }
    .a-fill { fill: #4A90D9; }
    .a-light { fill: #CADFF5; }
    .b-fill { fill: #27AE60; }
    .b-light { fill: #B8E6CC; }
    .c-fill { fill: #E67E22; }
    .c-light { fill: #FDEBD0; }
    .warp-fill { fill: #F1C40F; opacity: 0.6; }
    .coalesced { fill: #8E44AD; }
    .coalesced-light { fill: #D7BDE2; }
    .strided { fill: #C0392B; }
    .reg-fill { fill: #ECF0F1; }
    .outline { fill: none; stroke: #333; stroke-width: 1; }
    .outline-bold { fill: none; stroke: #333; stroke-width: 2; }
    .arrow { fill: none; stroke: #555; stroke-width: 1.5; marker-end: url(#arrowhead); }
    .arrow-bold { fill: none; stroke: #333; stroke-width: 2; marker-end: url(#arrowhead); }
    .dashed { stroke-dasharray: 4,3; }
    .thread-grid { fill: #F9F9F9; stroke: #CCC; stroke-width: 0.5; }
    .broadcast { fill: #2ECC71; opacity: 0.3; }
    .bank-conflict { fill: #E74C3C; opacity: 0.3; }
    .dim-label { font-size: 11px; fill: #888; font-style: italic; }
  </style>
  <defs>
    <marker id="arrowhead" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto">
      <path d="M0,0 L8,3 L0,6 Z" fill="#555"/>
    </marker>
    <marker id="arrowhead-red" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto">
      <path d="M0,0 L8,3 L0,6 Z" fill="#C0392B"/>
    </marker>
    <marker id="arrowhead-purple" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto">
      <path d="M0,0 L8,3 L0,6 Z" fill="#8E44AD"/>
    </marker>
    <linearGradient id="fma-grad" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#F39C12;stop-opacity:0.8"/>
      <stop offset="100%" style="stop-color:#E74C3C;stop-opacity:0.8"/>
    </linearGradient>
  </defs>

  <!-- Background -->
  <rect width="1400" height="1400" fill="#FAFAFA" rx="8"/>

  <!-- Title -->
  <text x="700" y="35" text-anchor="middle" class="title">Shared Memory Tiled GEMM: Memory Access Patterns</text>
  <text x="700" y="55" text-anchor="middle" class="small">BLK=32, block(32,32) = 1024 threads, As[32][32] + Bs[32][32] shared memory, 1 thread = 1 output element</text>

  <!-- ============================================================ -->
  <!-- SECTION 1: Block Tile Decomposition                          -->
  <!-- ============================================================ -->
  <line x1="40" y1="70" x2="1360" y2="70" stroke="#DDD" stroke-width="1"/>
  <text x="50" y="95" class="section-title">1. Block Tile Decomposition &amp; Thread-to-Output Mapping</text>

  <!-- As tile (32 x 32) -->
  <g transform="translate(80, 120)">
    <text x="50" y="-5" text-anchor="middle" class="subtitle">As [shared 32x32]</text>
    <rect width="100" height="100" class="a-light" stroke="#4A90D9" stroke-width="2" rx="2"/>
    <text x="-10" y="10" text-anchor="end" class="tiny">0</text>
    <text x="-10" y="55" text-anchor="end" class="tiny">16</text>
    <text x="-10" y="98" text-anchor="end" class="tiny">31</text>
    <text x="50" y="118" text-anchor="middle" class="dim-label">32 (K tile)</text>
    <text x="-25" y="50" text-anchor="middle" class="dim-label" transform="rotate(-90,-25,50)">32 (M tile)</text>
    <!-- Grid hints -->
    <line x1="0" y1="50" x2="100" y2="50" stroke="#4A90D9" stroke-width="0.4" opacity="0.4"/>
    <line x1="50" y1="0" x2="50" y2="100" stroke="#4A90D9" stroke-width="0.4" opacity="0.4"/>
    <!-- Warp 0 highlight (ty=0, all tx) = first row -->
    <rect width="100" height="3.1" fill="#F1C40F" opacity="0.6" rx="1"/>
  </g>

  <!-- Multiply sign -->
  <text x="215" y="185" text-anchor="middle" font-size="28" fill="#333">x</text>

  <!-- Bs tile (32 x 32) -->
  <g transform="translate(240, 145)">
    <text x="50" y="-5" text-anchor="middle" class="subtitle">Bs [shared 32x32]</text>
    <rect width="100" height="100" class="b-light" stroke="#27AE60" stroke-width="2" rx="2"/>
    <text x="2" y="115" text-anchor="start" class="tiny">0</text>
    <text x="50" y="115" text-anchor="middle" class="tiny">16</text>
    <text x="98" y="115" text-anchor="end" class="tiny">31</text>
    <text x="50" y="128" text-anchor="middle" class="dim-label">32 (N tile)</text>
    <text x="-15" y="50" text-anchor="middle" class="dim-label" transform="rotate(-90,-15,50)">32 (K tile)</text>
    <line x1="0" y1="50" x2="100" y2="50" stroke="#27AE60" stroke-width="0.4" opacity="0.4"/>
    <line x1="50" y1="0" x2="50" y2="100" stroke="#27AE60" stroke-width="0.4" opacity="0.4"/>
  </g>

  <!-- Equals sign -->
  <text x="380" y="185" text-anchor="middle" font-size="28" fill="#333">=</text>

  <!-- C tile (32x32) with thread grid -->
  <g transform="translate(410, 120)">
    <text x="75" y="-5" text-anchor="middle" class="subtitle">C tile [32x32 output]</text>
    <rect width="150" height="150" class="c-light" stroke="#E67E22" stroke-width="2" rx="2"/>

    <!-- 32x32 grid lines (show every 8th to suggest structure) -->
    <line x1="37.5" y1="0" x2="37.5" y2="150" stroke="#E67E22" stroke-width="0.3" opacity="0.4"/>
    <line x1="75" y1="0" x2="75" y2="150" stroke="#E67E22" stroke-width="0.3" opacity="0.4"/>
    <line x1="112.5" y1="0" x2="112.5" y2="150" stroke="#E67E22" stroke-width="0.3" opacity="0.4"/>
    <line x1="0" y1="37.5" x2="150" y2="37.5" stroke="#E67E22" stroke-width="0.3" opacity="0.4"/>
    <line x1="0" y1="75" x2="150" y2="75" stroke="#E67E22" stroke-width="0.3" opacity="0.4"/>
    <line x1="0" y1="112.5" x2="150" y2="112.5" stroke="#E67E22" stroke-width="0.3" opacity="0.4"/>

    <!-- Warp 0 highlight: ty=0, tx=0..31 → first row of C tile -->
    <rect width="150" height="4.7" fill="#F1C40F" opacity="0.5" rx="1"/>

    <!-- Single thread highlight -->
    <rect width="4.7" height="4.7" fill="#E74C3C" opacity="0.6" rx="0.5"/>
    <text x="10" y="10" class="tiny" fill="#C0392B" font-weight="bold">T0</text>

    <text x="75" y="168" text-anchor="middle" class="small">32x32 threads, each owns 1 output element</text>
  </g>

  <!-- Legend -->
  <g transform="translate(600, 128)">
    <rect width="12" height="12" fill="#F1C40F" opacity="0.5" stroke="#333" stroke-width="0.5"/>
    <text x="18" y="11" class="small">Warp 0 (ty=0, tx=0..31): row 0 of C tile</text>
    <rect y="18" width="12" height="12" fill="#E74C3C" opacity="0.6" stroke="#333" stroke-width="0.5"/>
    <text x="18" y="29" class="small">Thread 0: C[row0, col0] (1 output element)</text>
  </g>

  <!-- Thread layout explanation -->
  <g transform="translate(600, 180)">
    <text x="0" y="0" class="subtitle">Thread Layout (block 32x32):</text>
    <text x="0" y="18" class="code">ty = threadIdx.y, tx = threadIdx.x</text>
    <text x="0" y="34" class="code">row = blockIdx.y * 32 + ty</text>
    <text x="0" y="50" class="code">col = blockIdx.x * 32 + tx</text>
    <text x="0" y="70" class="code">Warp 0: tid 0-31 = (ty=0, tx=0..31)</text>
    <text x="0" y="86" class="code">Warp 1: tid 32-63 = (ty=1, tx=0..31)</text>
    <text x="0" y="102" class="small" fill="#888">K tiled by BLK=32: t=0, 32, 64, ... (K/32 tiles)</text>
  </g>

  <!-- K-dimension sliding visualization -->
  <g transform="translate(1000, 120)">
    <rect x="0" y="0" width="320" height="110" fill="white" stroke="#DDD" stroke-width="1" rx="6"/>
    <text x="160" y="20" text-anchor="middle" class="subtitle">K-Dimension Tiling</text>
    <line x1="10" y1="28" x2="310" y2="28" stroke="#EEE"/>
    <text x="15" y="48" class="code">for (t = 0; t &lt; K; t += 32) {</text>
    <text x="15" y="64" class="code">  load As[ty][tx] = A[row, t+tx];</text>
    <text x="15" y="80" class="code">  load Bs[ty][tx] = B[t+ty, col];</text>
    <text x="15" y="96" class="code">  __syncthreads(); compute; sync;</text>
    <text x="15" y="108" class="code">}</text>
  </g>

  <!-- ============================================================ -->
  <!-- SECTION 2: Cooperative Global → Shared Load                  -->
  <!-- ============================================================ -->
  <line x1="40" y1="290" x2="1360" y2="290" stroke="#DDD" stroke-width="1"/>
  <text x="50" y="318" class="section-title">2. Cooperative Global → Shared Memory Load: Coalescing Analysis (Warp 0)</text>

  <!-- LEFT: As loading -->
  <g transform="translate(60, 340)">
    <text x="280" y="0" text-anchor="middle" class="subtitle" fill="#8E44AD">Loading As: As[ty][tx] = A[row, t+tx] -- COALESCED</text>
    <text x="280" y="18" text-anchor="middle" class="small">Warp 0 = ty=0, tx=0..31: loads A[row0, t+0..t+31]</text>

    <!-- Warp 0 row visualization -->
    <g transform="translate(30, 35)">
      <!-- 32 consecutive elements -->
      <rect x="0" y="0" width="16" height="26" fill="#8E44AD" opacity="0.6" stroke="#2C3E50" stroke-width="0.6" rx="1"/>
      <rect x="16" y="0" width="16" height="26" fill="#8E44AD" opacity="0.6" stroke="#2C3E50" stroke-width="0.6" rx="1"/>
      <rect x="32" y="0" width="16" height="26" fill="#8E44AD" opacity="0.6" stroke="#2C3E50" stroke-width="0.6" rx="1"/>
      <rect x="48" y="0" width="16" height="26" fill="#8E44AD" opacity="0.6" stroke="#2C3E50" stroke-width="0.6" rx="1"/>
      <rect x="64" y="0" width="16" height="26" fill="#8E44AD" opacity="0.6" stroke="#2C3E50" stroke-width="0.6" rx="1"/>
      <rect x="80" y="0" width="16" height="26" fill="#8E44AD" opacity="0.6" stroke="#2C3E50" stroke-width="0.6" rx="1"/>
      <rect x="96" y="0" width="16" height="26" fill="#8E44AD" opacity="0.6" stroke="#2C3E50" stroke-width="0.6" rx="1"/>
      <rect x="112" y="0" width="16" height="26" fill="#8E44AD" opacity="0.6" stroke="#2C3E50" stroke-width="0.6" rx="1"/>
      <rect x="128" y="0" width="16" height="26" fill="#8E44AD" opacity="0.6" stroke="#2C3E50" stroke-width="0.6" rx="1"/>
      <rect x="144" y="0" width="16" height="26" fill="#8E44AD" opacity="0.6" stroke="#2C3E50" stroke-width="0.6" rx="1"/>
      <rect x="160" y="0" width="16" height="26" fill="#8E44AD" opacity="0.6" stroke="#2C3E50" stroke-width="0.6" rx="1"/>
      <rect x="176" y="0" width="16" height="26" fill="#8E44AD" opacity="0.6" stroke="#2C3E50" stroke-width="0.6" rx="1"/>
      <rect x="192" y="0" width="16" height="26" fill="#8E44AD" opacity="0.6" stroke="#2C3E50" stroke-width="0.6" rx="1"/>
      <rect x="208" y="0" width="16" height="26" fill="#8E44AD" opacity="0.6" stroke="#2C3E50" stroke-width="0.6" rx="1"/>
      <rect x="224" y="0" width="16" height="26" fill="#8E44AD" opacity="0.6" stroke="#2C3E50" stroke-width="0.6" rx="1"/>
      <rect x="240" y="0" width="16" height="26" fill="#8E44AD" opacity="0.6" stroke="#2C3E50" stroke-width="0.6" rx="1"/>
      <rect x="256" y="0" width="16" height="26" fill="#8E44AD" opacity="0.6" stroke="#2C3E50" stroke-width="0.6" rx="1"/>
      <rect x="272" y="0" width="16" height="26" fill="#8E44AD" opacity="0.6" stroke="#2C3E50" stroke-width="0.6" rx="1"/>
      <rect x="288" y="0" width="16" height="26" fill="#8E44AD" opacity="0.6" stroke="#2C3E50" stroke-width="0.6" rx="1"/>
      <rect x="304" y="0" width="16" height="26" fill="#8E44AD" opacity="0.6" stroke="#2C3E50" stroke-width="0.6" rx="1"/>
      <rect x="320" y="0" width="16" height="26" fill="#8E44AD" opacity="0.6" stroke="#2C3E50" stroke-width="0.6" rx="1"/>
      <rect x="336" y="0" width="16" height="26" fill="#8E44AD" opacity="0.6" stroke="#2C3E50" stroke-width="0.6" rx="1"/>
      <rect x="352" y="0" width="16" height="26" fill="#8E44AD" opacity="0.6" stroke="#2C3E50" stroke-width="0.6" rx="1"/>
      <rect x="368" y="0" width="16" height="26" fill="#8E44AD" opacity="0.6" stroke="#2C3E50" stroke-width="0.6" rx="1"/>
      <rect x="384" y="0" width="16" height="26" fill="#8E44AD" opacity="0.6" stroke="#2C3E50" stroke-width="0.6" rx="1"/>
      <rect x="400" y="0" width="16" height="26" fill="#8E44AD" opacity="0.6" stroke="#2C3E50" stroke-width="0.6" rx="1"/>
      <rect x="416" y="0" width="16" height="26" fill="#8E44AD" opacity="0.6" stroke="#2C3E50" stroke-width="0.6" rx="1"/>
      <rect x="432" y="0" width="16" height="26" fill="#8E44AD" opacity="0.6" stroke="#2C3E50" stroke-width="0.6" rx="1"/>
      <rect x="448" y="0" width="16" height="26" fill="#8E44AD" opacity="0.6" stroke="#2C3E50" stroke-width="0.6" rx="1"/>
      <rect x="464" y="0" width="16" height="26" fill="#8E44AD" opacity="0.6" stroke="#2C3E50" stroke-width="0.6" rx="1"/>
      <rect x="480" y="0" width="16" height="26" fill="#8E44AD" opacity="0.6" stroke="#2C3E50" stroke-width="0.6" rx="1"/>
      <rect x="496" y="0" width="16" height="26" fill="#8E44AD" opacity="0.6" stroke="#2C3E50" stroke-width="0.6" rx="1"/>

      <!-- Selected labels -->
      <text x="3" y="17" class="tiny" fill="white" font-weight="bold">T0</text>
      <text x="19" y="17" class="tiny" fill="white" font-weight="bold">T1</text>
      <text x="35" y="17" class="tiny" fill="white" font-weight="bold">T2</text>
      <text x="240" y="17" class="tiny" fill="white" font-weight="bold">...</text>
      <text x="481" y="17" class="tiny" fill="white" font-weight="bold">T30</text>
      <text x="497" y="17" class="tiny" fill="white" font-weight="bold">T31</text>

      <text x="256" y="42" text-anchor="middle" class="tiny" fill="#666">A[row0, t+0], A[row0, t+1], ..., A[row0, t+31] -- 32 consecutive floats = 128B</text>
    </g>

    <!-- Memory layout -->
    <g transform="translate(30, 92)">
      <rect x="0" y="0" width="512" height="22" fill="#8E44AD" opacity="0.25" stroke="#8E44AD" rx="3"/>
      <text x="256" y="16" text-anchor="middle" class="small" fill="#333">A row: 32 consecutive floats along K dimension = 128 bytes</text>

      <rect x="0" y="32" width="512" height="26" fill="#D5F5E3" stroke="#27AE60" rx="4"/>
      <text x="256" y="50" text-anchor="middle" class="small" fill="#1E8449" font-weight="bold">1 coalesced 128B transaction per warp (perfect!)</text>
    </g>
  </g>

  <!-- RIGHT: Bs loading -->
  <g transform="translate(640, 340)">
    <text x="340" y="0" text-anchor="middle" class="subtitle" fill="#8E44AD">Loading Bs: Bs[ty][tx] = B[t+ty, col] -- COALESCED</text>
    <text x="340" y="18" text-anchor="middle" class="small">Warp 0 = ty=0, tx=0..31: loads B[t+0, col+0..col+31]</text>

    <!-- Warp 0 row visualization -->
    <g transform="translate(30, 35)">
      <!-- 32 consecutive elements -->
      <rect x="0" y="0" width="16" height="26" fill="#8E44AD" opacity="0.6" stroke="#2C3E50" stroke-width="0.6" rx="1"/>
      <rect x="16" y="0" width="16" height="26" fill="#8E44AD" opacity="0.6" stroke="#2C3E50" stroke-width="0.6" rx="1"/>
      <rect x="32" y="0" width="16" height="26" fill="#8E44AD" opacity="0.6" stroke="#2C3E50" stroke-width="0.6" rx="1"/>
      <rect x="48" y="0" width="16" height="26" fill="#8E44AD" opacity="0.6" stroke="#2C3E50" stroke-width="0.6" rx="1"/>
      <rect x="64" y="0" width="16" height="26" fill="#8E44AD" opacity="0.6" stroke="#2C3E50" stroke-width="0.6" rx="1"/>
      <rect x="80" y="0" width="16" height="26" fill="#8E44AD" opacity="0.6" stroke="#2C3E50" stroke-width="0.6" rx="1"/>
      <rect x="96" y="0" width="16" height="26" fill="#8E44AD" opacity="0.6" stroke="#2C3E50" stroke-width="0.6" rx="1"/>
      <rect x="112" y="0" width="16" height="26" fill="#8E44AD" opacity="0.6" stroke="#2C3E50" stroke-width="0.6" rx="1"/>
      <rect x="128" y="0" width="16" height="26" fill="#8E44AD" opacity="0.6" stroke="#2C3E50" stroke-width="0.6" rx="1"/>
      <rect x="144" y="0" width="16" height="26" fill="#8E44AD" opacity="0.6" stroke="#2C3E50" stroke-width="0.6" rx="1"/>
      <rect x="160" y="0" width="16" height="26" fill="#8E44AD" opacity="0.6" stroke="#2C3E50" stroke-width="0.6" rx="1"/>
      <rect x="176" y="0" width="16" height="26" fill="#8E44AD" opacity="0.6" stroke="#2C3E50" stroke-width="0.6" rx="1"/>
      <rect x="192" y="0" width="16" height="26" fill="#8E44AD" opacity="0.6" stroke="#2C3E50" stroke-width="0.6" rx="1"/>
      <rect x="208" y="0" width="16" height="26" fill="#8E44AD" opacity="0.6" stroke="#2C3E50" stroke-width="0.6" rx="1"/>
      <rect x="224" y="0" width="16" height="26" fill="#8E44AD" opacity="0.6" stroke="#2C3E50" stroke-width="0.6" rx="1"/>
      <rect x="240" y="0" width="16" height="26" fill="#8E44AD" opacity="0.6" stroke="#2C3E50" stroke-width="0.6" rx="1"/>
      <rect x="256" y="0" width="16" height="26" fill="#8E44AD" opacity="0.6" stroke="#2C3E50" stroke-width="0.6" rx="1"/>
      <rect x="272" y="0" width="16" height="26" fill="#8E44AD" opacity="0.6" stroke="#2C3E50" stroke-width="0.6" rx="1"/>
      <rect x="288" y="0" width="16" height="26" fill="#8E44AD" opacity="0.6" stroke="#2C3E50" stroke-width="0.6" rx="1"/>
      <rect x="304" y="0" width="16" height="26" fill="#8E44AD" opacity="0.6" stroke="#2C3E50" stroke-width="0.6" rx="1"/>
      <rect x="320" y="0" width="16" height="26" fill="#8E44AD" opacity="0.6" stroke="#2C3E50" stroke-width="0.6" rx="1"/>
      <rect x="336" y="0" width="16" height="26" fill="#8E44AD" opacity="0.6" stroke="#2C3E50" stroke-width="0.6" rx="1"/>
      <rect x="352" y="0" width="16" height="26" fill="#8E44AD" opacity="0.6" stroke="#2C3E50" stroke-width="0.6" rx="1"/>
      <rect x="368" y="0" width="16" height="26" fill="#8E44AD" opacity="0.6" stroke="#2C3E50" stroke-width="0.6" rx="1"/>
      <rect x="384" y="0" width="16" height="26" fill="#8E44AD" opacity="0.6" stroke="#2C3E50" stroke-width="0.6" rx="1"/>
      <rect x="400" y="0" width="16" height="26" fill="#8E44AD" opacity="0.6" stroke="#2C3E50" stroke-width="0.6" rx="1"/>
      <rect x="416" y="0" width="16" height="26" fill="#8E44AD" opacity="0.6" stroke="#2C3E50" stroke-width="0.6" rx="1"/>
      <rect x="432" y="0" width="16" height="26" fill="#8E44AD" opacity="0.6" stroke="#2C3E50" stroke-width="0.6" rx="1"/>
      <rect x="448" y="0" width="16" height="26" fill="#8E44AD" opacity="0.6" stroke="#2C3E50" stroke-width="0.6" rx="1"/>
      <rect x="464" y="0" width="16" height="26" fill="#8E44AD" opacity="0.6" stroke="#2C3E50" stroke-width="0.6" rx="1"/>
      <rect x="480" y="0" width="16" height="26" fill="#8E44AD" opacity="0.6" stroke="#2C3E50" stroke-width="0.6" rx="1"/>
      <rect x="496" y="0" width="16" height="26" fill="#8E44AD" opacity="0.6" stroke="#2C3E50" stroke-width="0.6" rx="1"/>
      <rect x="512" y="0" width="16" height="26" fill="#8E44AD" opacity="0.6" stroke="#2C3E50" stroke-width="0.6" rx="1"/>

      <text x="3" y="17" class="tiny" fill="white" font-weight="bold">T0</text>
      <text x="19" y="17" class="tiny" fill="white" font-weight="bold">T1</text>
      <text x="35" y="17" class="tiny" fill="white" font-weight="bold">T2</text>
      <text x="240" y="17" class="tiny" fill="white" font-weight="bold">...</text>
      <text x="497" y="17" class="tiny" fill="white" font-weight="bold">T30</text>
      <text x="513" y="17" class="tiny" fill="white" font-weight="bold">T31</text>

      <text x="264" y="42" text-anchor="middle" class="tiny" fill="#666">B[t+0, col+0], B[t+0, col+1], ..., B[t+0, col+31] -- 32 consecutive floats = 128B</text>
    </g>

    <!-- Memory layout -->
    <g transform="translate(30, 92)">
      <rect x="0" y="0" width="530" height="22" fill="#8E44AD" opacity="0.25" stroke="#8E44AD" rx="3"/>
      <text x="265" y="16" text-anchor="middle" class="small" fill="#333">B row: 32 consecutive floats along N dimension = 128 bytes</text>

      <rect x="0" y="32" width="530" height="26" fill="#D5F5E3" stroke="#27AE60" rx="4"/>
      <text x="265" y="50" text-anchor="middle" class="small" fill="#1E8449" font-weight="bold">1 coalesced 128B transaction per warp (perfect!)</text>
    </g>

    <!-- Full tile note -->
    <g transform="translate(30, 130)">
      <text x="0" y="0" class="small" fill="#555">32 warps x 1 row each = full 32x32 tile loaded cooperatively</text>
      <text x="0" y="16" class="small" fill="#555">Each thread loads exactly 1 As element + 1 Bs element per tile</text>
    </g>
  </g>

  <!-- ============================================================ -->
  <!-- SECTION 3: Shared Memory Compute (Bank Analysis)             -->
  <!-- ============================================================ -->
  <line x1="40" y1="520" x2="1360" y2="520" stroke="#DDD" stroke-width="1"/>
  <text x="50" y="548" class="section-title">3. Shared Memory Compute: Bank Conflict Analysis (inner loop: sum += As[ty][i] * Bs[i][tx])</text>

  <!-- As reads: broadcast -->
  <g transform="translate(60, 570)">
    <text x="280" y="0" text-anchor="middle" class="subtitle" fill="#4A90D9">As[ty][i]: BROADCAST -- no bank conflicts</text>
    <text x="280" y="18" text-anchor="middle" class="small">Warp 0 = all ty=0: every thread reads As[0][i] -- same address</text>

    <g transform="translate(20, 35)">
      <rect x="0" y="0" width="520" height="65" fill="#EBF5FB" stroke="#4A90D9" stroke-width="1" rx="4"/>
      <text x="260" y="18" text-anchor="middle" class="small bold" fill="#4A90D9">Warp 0: threads T0..T31 (all have ty=0)</text>
      <text x="15" y="38" class="code">T0:  As[0][i]  ← same address</text>
      <text x="170" y="38" class="code">T1:  As[0][i]  ← same address</text>
      <text x="325" y="38" class="code">... T31: As[0][i]</text>
      <text x="15" y="55" class="code" fill="#1E8449">All 32 threads read IDENTICAL address → hardware broadcast → 0 bank conflicts</text>

      <!-- Verdict -->
      <rect x="0" y="75" width="520" height="26" fill="#D5F5E3" stroke="#27AE60" rx="4"/>
      <text x="260" y="93" text-anchor="middle" class="small" fill="#1E8449" font-weight="bold">BROADCAST: 32 threads reading same address = 1 smem transaction</text>
    </g>
  </g>

  <!-- Bs reads: no conflicts -->
  <g transform="translate(640, 570)">
    <text x="340" y="0" text-anchor="middle" class="subtitle" fill="#27AE60">Bs[i][tx]: 32 different banks -- NO conflicts</text>
    <text x="340" y="18" text-anchor="middle" class="small">Each thread has different tx → reads different column → different bank</text>

    <g transform="translate(20, 35)">
      <rect x="0" y="0" width="640" height="65" fill="#EBF5FB" stroke="#27AE60" stroke-width="1" rx="4"/>
      <text x="320" y="18" text-anchor="middle" class="small bold" fill="#27AE60">Warp 0: each thread reads Bs[i][tx] with unique tx</text>
      <text x="15" y="38" class="code">T0: Bs[i][ 0] → bank  0</text>
      <text x="180" y="38" class="code">T1: Bs[i][ 1] → bank  1</text>
      <text x="345" y="38" class="code">T2: Bs[i][ 2] → bank  2</text>
      <text x="490" y="38" class="code">... T31: → bank 31</text>
      <text x="15" y="55" class="code" fill="#1E8449">32 threads × 32 different banks → perfect spread, zero conflicts</text>

      <!-- Verdict -->
      <rect x="0" y="75" width="640" height="26" fill="#D5F5E3" stroke="#27AE60" rx="4"/>
      <text x="320" y="93" text-anchor="middle" class="small" fill="#1E8449" font-weight="bold">CONFLICT-FREE: all 32 banks active, 1 smem transaction</text>
    </g>

    <!-- Stats -->
    <g transform="translate(0, 120)">
      <rect x="0" y="0" width="640" height="65" fill="white" stroke="#DDD" stroke-width="1" rx="6"/>
      <text x="320" y="18" text-anchor="middle" class="subtitle">Smem Compute Efficiency Per Inner Iteration</text>
      <text x="15" y="38" class="code">2 smem loads (As broadcast + Bs conflict-free) → 1 FMA</text>
      <text x="15" y="55" class="code">Over BLK=32 inner iterations: 64 smem loads → 32 FMAs (per thread)</text>
    </g>
  </g>

  <!-- ============================================================ -->
  <!-- SECTION 4: Data Reuse Analysis                               -->
  <!-- ============================================================ -->
  <line x1="40" y1="780" x2="1360" y2="780" stroke="#DDD" stroke-width="1"/>
  <text x="50" y="808" class="section-title">4. Data Reuse Analysis -- Why Tiling Helps</text>

  <g transform="translate(60, 830)">
    <!-- As reuse -->
    <g transform="translate(0, 0)">
      <rect x="0" y="0" width="400" height="120" fill="#EBF5FB" stroke="#4A90D9" stroke-width="1" rx="6"/>
      <text x="200" y="20" text-anchor="middle" class="subtitle" fill="#4A90D9">As[ty][i] reuse: 32x</text>
      <line x1="10" y1="28" x2="390" y2="28" stroke="#CADFF5"/>
      <text x="15" y="48" class="code">Each As element loaded once from global</text>
      <text x="15" y="64" class="code">Used by 32 threads with same ty value</text>
      <text x="15" y="80" class="code">(all threads in the same row of block)</text>
      <text x="15" y="100" class="code bold" fill="#4A90D9">32x reuse: 1 global load → 32 smem reads</text>
    </g>

    <!-- Bs reuse -->
    <g transform="translate(430, 0)">
      <rect x="0" y="0" width="400" height="120" fill="#EBF5FB" stroke="#27AE60" stroke-width="1" rx="6"/>
      <text x="200" y="20" text-anchor="middle" class="subtitle" fill="#27AE60">Bs[i][tx] reuse: 32x</text>
      <line x1="10" y1="28" x2="390" y2="28" stroke="#B8E6CC"/>
      <text x="15" y="48" class="code">Each Bs element loaded once from global</text>
      <text x="15" y="64" class="code">Used by 32 threads with same tx value</text>
      <text x="15" y="80" class="code">(all threads in the same column of block)</text>
      <text x="15" y="100" class="code bold" fill="#27AE60">32x reuse: 1 global load → 32 smem reads</text>
    </g>

    <!-- Comparison stats -->
    <g transform="translate(860, 0)">
      <rect x="0" y="0" width="420" height="120" fill="white" stroke="#333" stroke-width="1.5" rx="6"/>
      <text x="210" y="20" text-anchor="middle" class="subtitle">Global Load Efficiency Comparison</text>
      <line x1="10" y1="28" x2="410" y2="28" stroke="#EEE"/>
      <text x="15" y="48" class="code">Per 32x32 tile (one K-step):</text>
      <text x="15" y="64" class="code">  Global loads: 32*32 + 32*32 = 2048</text>
      <text x="15" y="80" class="code">  FMAs:         32 * 32 * 32  = 32768</text>
      <line x1="10" y1="90" x2="410" y2="90" stroke="#EEE"/>
      <text x="15" y="108" class="code bold" fill="#1E8449">FMA-to-load ratio: 32768/2048 = 16:1</text>
    </g>

    <!-- Naive comparison -->
    <g transform="translate(0, 135)">
      <rect x="0" y="0" width="1280" height="48" fill="#FCF3CF" stroke="#F1C40F" stroke-width="1" rx="6"/>
      <text x="640" y="18" text-anchor="middle" class="subtitle" fill="#7D6608">Improvement Over Naive</text>
      <text x="50" y="38" class="code" fill="#C0392B">Naive: 2 global loads → 1 FMA (ratio 0.5:1)</text>
      <text x="500" y="38" class="code" fill="#1E8449">Tiled: 2048 global loads → 32768 FMAs (ratio 16:1)</text>
      <text x="980" y="38" class="code bold" fill="#7D6608">→ 32x less global memory traffic!</text>
    </g>

    <!-- Per-thread note -->
    <g transform="translate(0, 198)">
      <text x="0" y="0" class="small" fill="#555">Note: per-thread compute-to-smem-load ratio is still 1 FMA per 2 smem loads (0.5:1). The big win is</text>
      <text x="0" y="16" class="small" fill="#555">replacing 2 GLOBAL loads with 2 SHARED MEMORY loads per FMA. Smem latency: ~20 cycles vs global: ~400 cycles.</text>
    </g>
  </g>

  <!-- ============================================================ -->
  <!-- SECTION 5: Data Flow Summary                                 -->
  <!-- ============================================================ -->
  <line x1="40" y1="1075" x2="1360" y2="1075" stroke="#DDD" stroke-width="1"/>
  <text x="50" y="1103" class="section-title">5. Data Flow Summary</text>

  <g transform="translate(60, 1125)">
    <!-- Pipeline stages -->
    <!-- Stage 1: Global → Shared -->
    <rect x="0" y="0" width="280" height="100" fill="#EBF5FB" stroke="#4A90D9" stroke-width="2" rx="8"/>
    <text x="140" y="20" text-anchor="middle" class="subtitle" fill="#4A90D9">Global → Shared Memory</text>
    <text x="10" y="40" class="code">Cooperative load (1024 threads)</text>
    <text x="10" y="56" class="code">As: 32x32 = 1024 floats (1/thread)</text>
    <text x="10" y="72" class="code">Bs: 32x32 = 1024 floats (1/thread)</text>
    <text x="10" y="88" class="code" fill="#1E8449">Both fully coalesced</text>

    <!-- Arrow -->
    <path d="M290,50 L340,50" class="arrow-bold"/>
    <text x="315" y="42" text-anchor="middle" class="tiny" fill="#F1C40F" font-weight="bold">sync</text>

    <!-- Stage 2: Shared → Register → FMA -->
    <rect x="350" y="0" width="320" height="100" fill="#FDEBD0" stroke="#E67E22" stroke-width="2" rx="8"/>
    <text x="510" y="20" text-anchor="middle" class="subtitle" fill="#E67E22">Shared → Register → FMA</text>
    <text x="360" y="40" class="code">for i in 0..31:</text>
    <text x="360" y="56" class="code">  a_val = As[ty][i]  (broadcast)</text>
    <text x="360" y="72" class="code">  b_val = Bs[i][tx]  (bank-free)</text>
    <text x="360" y="88" class="code" fill="#E67E22">  sum += a_val * b_val  (FMA)</text>

    <!-- Arrow -->
    <path d="M680,50 L730,50" class="arrow-bold"/>
    <text x="705" y="42" text-anchor="middle" class="tiny" fill="#F1C40F" font-weight="bold">sync</text>

    <!-- Stage 3: next tile / store -->
    <rect x="740" y="0" width="220" height="100" fill="#D5F5E3" stroke="#27AE60" stroke-width="2" rx="8"/>
    <text x="850" y="20" text-anchor="middle" class="subtitle" fill="#27AE60">Register → Global (Store)</text>
    <text x="750" y="42" class="code">After all K/32 tiles:</text>
    <text x="750" y="58" class="code">C[row*N + col] = sum</text>
    <text x="750" y="76" class="code" fill="#1E8449">Coalesced store</text>
    <text x="750" y="92" class="code">(1 write per thread)</text>

    <!-- Loop arrow -->
    <path d="M510,100 L510,120 L140,120 L140,100" fill="none" stroke="#888" stroke-width="1.5" stroke-dasharray="6,3"/>
    <text x="325" y="118" text-anchor="middle" class="small" fill="#888">repeat for K/32 tiles</text>

    <!-- Key insight box -->
    <g transform="translate(0, 140)">
      <rect x="0" y="0" width="960" height="65" fill="white" stroke="#333" stroke-width="1.5" rx="6"/>
      <text x="480" y="18" text-anchor="middle" class="subtitle">Key Insight: Shared Memory Enables Data Reuse</text>
      <text x="15" y="38" class="code" fill="#C0392B">Naive:  Global A → Reg → FMA → Reg → Global C  (2 global loads per FMA, 0.5:1 ratio)</text>
      <text x="15" y="55" class="code" fill="#1E8449">Tiled:  Global → Smem (cooperative) → Reg → FMA  (2048 global loads → 32768 FMAs, 16:1 ratio, 32x improvement)</text>
    </g>

    <!-- syncthreads note -->
    <g transform="translate(0, 218)">
      <rect width="960" height="45" fill="#FCF3CF" stroke="#F1C40F" stroke-width="1" rx="4"/>
      <text x="480" y="18" text-anchor="middle" class="small bold" fill="#7D6608">__syncthreads() placement:</text>
      <text x="480" y="34" text-anchor="middle" class="small" fill="#7D6608">After cooperative smem load (before compute) AND after compute (before next tile load)</text>
    </g>
  </g>

  <!-- Footer -->
  <text x="700" y="1385" text-anchor="middle" class="tiny" fill="#AAA">matmul_tiled&lt;32&gt; -- block(32,32), shared memory tiling, 32x data reuse vs naive</text>
</svg>